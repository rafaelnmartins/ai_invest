<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kimi Chat • Worker</title>
  <meta name="description" content="Chat simples consumindo a rota /kimi do seu Cloudflare Worker." />
  <style>
    :root{ --bg:#0b1220; --panel:#0f172a; --ink:#e2e8f0; --muted:#94a3b8; --acc:#22d3ee; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{margin:0;font-size:20px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .grow{flex:1}
    label{font-size:12px;color:var(--muted)}
    select,input,textarea,button{font:inherit;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b1220;color:var(--ink);padding:10px 12px}
    textarea{width:100%;min-height:90px;resize:vertical}
    button{cursor:pointer;background:#111827}
    button:hover{background:#0f172a}
    #log{display:flex;flex-direction:column;gap:10px}
    .msg{padding:12px;border-radius:12px;line-height:1.5}
    .user{background:#111827;border:1px solid rgba(255,255,255,.07)}
    .assistant{background:#0b1220;border:1px solid rgba(34,211,238,.25)}
    .sys{background:#0b1220;border:1px dashed rgba(255,255,255,.2);color:var(--muted);font-size:13px}
    .status{font-size:12px;color:var(--muted)}
    .badge{display:inline-flex;gap:8px;align-items:center;background:#0b1220;border:1px solid rgba(255,255,255,.12);padding:6px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
    .err{color:#fca5a5}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:12px}
    a{color:var(--acc);text-decoration:none}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Kimi Chat <span class="small">via seu Worker</span></h1>
      <span class="badge" id="status">Pronto</span>
    </header>

    <section class="card" style="margin-bottom:12px">
      <div class="row">
        <div class="grow">
          <label for="endpoint">Endpoint do Worker</label>
          <input id="endpoint" value="https://shiny-sea-44d3.rafaelnm.workers.dev/kimi" class="grow" />
        </div>
        <div>
          <label for="model">Modelo</label>
          <select id="model">
            <option value="moonshotai/kimi-k2:free">moonshotai/kimi-k2:free</option>
            <option value="meta-llama/llama-3.1-8b-instruct:free">llama-3.1-8b-instruct:free</option>
            <option value="">(usar o padrão do Worker)</option>
          </select>
        </div>
      </div>
      <div style="margin-top:10px">
        <label for="system">System prompt (opcional)</label>
        <input id="system" placeholder="Você é um assistente útil e direto." style="width:100%" />
      </div>
    </section>

    <section class="card" style="margin-bottom:12px">
      <div>
        <label for="userInput">Sua pergunta</label>
        <textarea id="userInput" placeholder="Escreva sua pergunta para a Kimi..."></textarea>
      </div>
      <div class="row" style="margin-top:10px;align-items:center">
        <button id="sendBtn">Enviar</button>
        <button id="clearBtn">Limpar histórico</button>
        <span class="status" id="hint">Dica: o modelo free exige “Free model publication” ativado na sua conta do OpenRouter.</span>
      </div>
    </section>

    <section class="card">
      <div id="log"></div>
    </section>

    <footer>© <span id="y"></span> • Feito para testar <code>/kimi</code> no seu Worker</footer>
  </div>

  <script>
    const $status = document.getElementById('status');
    const $log = document.getElementById('log');
    const $send = document.getElementById('sendBtn');
    const $clear = document.getElementById('clearBtn');
    const $endpoint = document.getElementById('endpoint');
    const $model = document.getElementById('model');
    const $system = document.getElementById('system');
    const $input = document.getElementById('userInput');
    document.getElementById('y').textContent = new Date().getFullYear();

    // Histórico apenas em memória da página
    const messages = [];

    function setStatus(txt, isErr=false){
      $status.textContent = txt;
      $status.style.borderColor = isErr ? '#fca5a5' : 'rgba(255,255,255,.12)';
      $status.style.color = isErr ? '#fca5a5' : '';
    }

    function appendMessage(role, content){
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'user' : role === 'assistant' ? 'assistant' : 'sys');
      div.textContent = content;
      $log.appendChild(div);
      // scroll
      setTimeout(()=>{ div.scrollIntoView({behavior:'smooth', block:'end'}); }, 10);
    }

    function ensureSystem(){
      const sys = ($system.value || '').trim();
      const hasSystem = messages.find(m => m.role === 'system');
      if(sys && !hasSystem){
        messages.unshift({ role:'system', content: sys });
        appendMessage('system', `System: ${sys}`);
      }
    }

    async function send(){
      const txt = ($input.value || '').trim();
      if(!txt) return;
      ensureSystem();
      messages.push({ role:'user', content: txt });
      appendMessage('user', txt);
      $input.value = '';

      const body = { messages };
      const model = $model.value.trim();
      if(model) body.model = model;

      const endpoint = ($endpoint.value || '').trim();
      setStatus('Enviando…');
      let resp;
      try{
        resp = await fetch(endpoint, {
          method: 'POST',
          headers: { 'content-type':'application/json' },
          body: JSON.stringify(body),
          // Não enviar credentials; CORS do Worker é "*"
          mode: 'cors',
        });
      }catch(e){
        console.error('fetch error', e);
        setStatus('Falha de rede', true);
        appendMessage('system', 'Erro de rede ao chamar o endpoint.');
        return;
      }

      // Não-OK: mostra texto bruto
      if(!resp.ok){
        const t = await resp.text().catch(()=> '');
        console.error('HTTP error', resp.status, t);
        setStatus(`HTTP ${resp.status}`, true);
        appendMessage('system', `Erro HTTP ${resp.status}: ${t}`);
        return;
      }

      // Tenta stream (SSE/ndjson) primeiro
      const ctype = (resp.headers.get('content-type') || '').toLowerCase();
      try{
        if(ctype.includes('text/event-stream') || ctype.includes('x-ndjson') || ctype.includes('text/')){
          setStatus('Recebendo (stream)…');
          const reader = resp.body.getReader();
          const decoder = new TextDecoder('utf-8');
          let acc = '';
          let printedOnce = false;

          while(true){
            const { value, done } = await reader.read();
            if(done) break;
            acc += decoder.decode(value, { stream:true });

            // tenta dividir por linhas
            const parts = acc.split(/\r?\n/);
            acc = parts.pop() || '';
            for(const line of parts){
              const s = line.trim();
              if(!s) continue;
              // suporta "data: {json}" e puro JSON
              const payload = s.startsWith('data:') ? s.slice(5).trim() : s;
              try{
                const j = JSON.parse(payload);
                const delta = j.choices?.[0]?.delta?.content ?? j.choices?.[0]?.message?.content ?? '';
                if(delta){
                  if(!printedOnce){ appendMessage('assistant', delta); printedOnce = true; }
                  else{
                    // adiciona no último balão do assistant
                    const last = Array.from($log.querySelectorAll('.msg.assistant')).pop();
                    if(last) last.textContent += delta;
                  }
                }
              }catch{
                // linha de texto puro
                if(!printedOnce){ appendMessage('assistant', s); printedOnce = true; }
                else{
                  const last = Array.from($log.querySelectorAll('.msg.assistant')).pop();
                  if(last) last.textContent += s;
                }
              }
            }
          }
          setStatus('OK');
          return;
        }

        // JSON padrão (OpenRouter)
        const json = await resp.json();
        const text = json?.choices?.[0]?.message?.content ?? '(sem conteúdo)';
        appendMessage('assistant', text);
        setStatus('OK');
      }catch(e){
        console.error('parse error', e);
        setStatus('Erro ao ler resposta', true);
        const t = await resp.text().catch(()=> '');
        appendMessage('system', 'Não consegui interpretar a resposta. Veja console.');
        console.log('Raw response body:', t);
      }
    }

    $send.addEventListener('click', send);
    $input.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){ send(); }
    });
    $clear.addEventListener('click', ()=>{
      messages.length = 0;
      $log.innerHTML = '';
      setStatus('Pronto');
      if($system.value.trim()){
        appendMessage('system', `System: ${$system.value.trim()}`);
        messages.push({ role:'system', content: $system.value.trim() });
      }
    });

    // Pré-popula uma mensagem system (visual)
    (function init(){
      const sys = 'Você é um assistente útil e direto.';
      $system.value = sys;
      appendMessage('system', `System: ${sys}`);
      messages.push({ role:'system', content: sys });
    })();
  </script>
</body>
</html>
