<script src="https://s3.tradingview.com/tv.js"></script>
<script>
// ===== Config =====
const QUOTE_API_BASE = "https://shiny-sea-44d3.rafaelnm.workers.dev/quotes";

// ===== i18n =====
const I18N = {
  pt:{
    title:"Dicas AI Investimentos para familia e amigos",
    quick_tips:"Dicas rápidas",
    tip1:"Defina <strong>entrada, stop e alvo</strong> antes de executar.",
    tip2:"Use <strong>gestão de risco</strong> por posição e por carteira.",
    tip3:"Combine <strong>fundamental + técnico</strong> para decisões mais sólidas.",
    chart_title:"Gráfico (TradingView)",
    alerts_title:"Alertas (janela interna)",
    ticker_title:"Ticker de Cotações",
    positions_title:"Minhas posições",
    add_position:"Adicionar posição",
    clear_all:"Limpar tudo",
    export_csv:"Exportar CSV",
    th_symbol:"Símbolo",
    th_avg:"Preço médio",
    th_last:"Preço atual",
    th_pl:"P/L %",
    th_note:"Obs.",
    th_actions:"Ações",
    disclaimer:"Site educacional, não é recomendação de investimento.",
    edit:"Editar", del:"Excluir",
    totals:"Total de posições: {n}",
    refresh:"Atualizar preços",
    set_symbol:"Carregar símbolo",
    add_from_chart:"Adicionar à lista",
    open_tv:"Abrir no TradingView"
  },
  en:{
    title:"Dicas AI Investimentos para familia e amigos",
    quick_tips:"Quick tips",
    tip1:"Define <strong>entry, stop and target</strong> before executing.",
    tip2:"Use <strong>risk management</strong> per position and portfolio.",
    tip3:"Combine <strong>fundamental + technical</strong> for stronger decisions.",
    chart_title:"Chart (TradingView)",
    alerts_title:"Alerts (embedded window)",
    ticker_title:"Quotes Ticker",
    positions_title:"My positions",
    add_position:"Add position",
    clear_all:"Clear all",
    export_csv:"Export CSV",
    th_symbol:"Symbol",
    th_avg:"Avg. price",
    th_last:"Last price",
    th_pl:"P/L %",
    th_note:"Note",
    th_actions:"Actions",
    disclaimer:"Educational site, not investment advice.",
    edit:"Edit", del:"Delete",
    totals:"Total positions: {n}",
    refresh:"Refresh prices",
    set_symbol:"Load symbol",
    add_from_chart:"Add from chart",
    open_tv:"Open on TradingView"
  }
};

document.addEventListener('DOMContentLoaded', () => {
  // ===== idioma =====
  function detectLang(){
    const nav = navigator.language || navigator.userLanguage || 'pt-BR';
    return String(nav).toLowerCase().startsWith('en') ? 'en' : 'pt';
  }
  let currentLang = (localStorage.getItem('lang') || detectLang());
  const langLabel = document.getElementById('langLabel');

  function applyI18n(){
    const dict = I18N[currentLang] || I18N.pt;
    document.documentElement.lang = currentLang === 'en' ? 'en' : 'pt-br';
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      if(dict[key]) el.innerHTML = dict[key];
    });
    langLabel.textContent = currentLang.toUpperCase();
    // recarrega gráfico com locale
    loadChart(getCurrentSymbol(), currentLang === 'en' ? 'en' : 'br');
    renderPositions();
  }

  document.getElementById('langToggle').addEventListener('click', ()=>{
    currentLang = currentLang === 'en' ? 'pt' : 'en';
    localStorage.setItem('lang', currentLang);
    applyI18n();
  });

  // ===== TradingView =====
  const DEFAULT_SYMBOL = 'NASDAQ:AAPL';
  let tvWidgetInstance;

  function getCurrentSymbol(){ return window.__CURRENT_SYMBOL || DEFAULT_SYMBOL; }
  function setCurrentSymbol(s){ window.__CURRENT_SYMBOL = s; }

  function loadChart(symbol, locale){
    const tvStatus = document.getElementById('tvStatus');
    try{
      const loc = locale || (currentLang === 'en' ? 'en' : 'br');
      const s = (symbol || DEFAULT_SYMBOL).trim();
      setCurrentSymbol(s);
      if(tvWidgetInstance && typeof tvWidgetInstance.remove === 'function'){
        tvWidgetInstance.remove();
      }
      tvWidgetInstance = new TradingView.widget({
        autosize: true,
        symbol: s,
        interval: "60",
        timezone: "Etc/UTC",
        theme: "light",
        style: "1",
        locale: loc,
        enable_publishing: false,
        container_id: "tradingview_chart",
        withdateranges: true,
        allow_symbol_change: true
      });
      document.getElementById('openTV').href = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(s)}`;
      const input = document.getElementById('chartSymbolInput');
      if(input && !input.value) input.value = s;
      tvStatus.textContent = '';
    }catch(e){
      tvStatus.textContent = (currentLang==='en'?'Could not load chart now.':'Não foi possível carregar o gráfico agora.');
      console.error('TradingView error', e);
    }
  }

  // Controles de símbolo
  document.getElementById('setChartBtn').addEventListener('click', ()=>{
    const s = document.getElementById('chartSymbolInput').value.trim();
    if(!s){ alert(currentLang==='en'?'Enter a symbol':'Informe um símbolo'); return; }
    loadChart(s);
  });
  document.getElementById('addFromChartBtn').addEventListener('click', ()=>{
    document.getElementById('posSymbol').value = getCurrentSymbol();
    document.getElementById('posAvg').focus();
  });

  // ===== Posições =====
  const posKey = 'positions_v4_pl_only_autorefresh';
  const cacheKey = 'positions_last_prices_cache_v1';
  const $tbody = document.querySelector('#posTable tbody');
  const $totals = document.getElementById('totals');
  const quoteStatus = document.getElementById('quoteStatus');
  const lastRefreshEl = document.getElementById('lastRefresh');

  function readPositions(){
    try{ return JSON.parse(localStorage.getItem(posKey)) || []; }catch(e){ return []; }
  }
  function writePositions(data){ localStorage.setItem(posKey, JSON.stringify(data)); }
  function readCache(){ try{ return JSON.parse(localStorage.getItem(cacheKey)) || {}; }catch(e){ return {}; } }
  function writeCache(obj){ localStorage.setItem(cacheKey, JSON.stringify(obj||{})); }

  function number(v){ return isNaN(parseFloat(v)) ? 0 : parseFloat(v); }
  function fmt(n, digits=2){ if(n===null||n===undefined||isNaN(n)) return '-'; return Number(n).toFixed(digits); }
  function fmtPct(n){ if(n===null||n===undefined||isNaN(n)) return '-'; return (n>=0?'+':'')+Number(n).toFixed(2)+'%'; }

  function renderPositions(quotesMap={}){
    const dict = I18N[currentLang] || I18N.pt;
    const data = readPositions();
    $tbody.innerHTML = '';
    data.forEach((row, idx)=>{
      const last = (typeof quotesMap[row.symbol] === 'number') ? quotesMap[row.symbol] : null;
      const pl = (last && row.avg>0) ? ((last/row.avg-1)*100) : null;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><button class="btn" data-act="show" data-idx="${idx}" title="Mostrar no gráfico">${row.symbol}</button></td>
        <td>${fmt(row.avg)}</td>
        <td>${last===null?'-':fmt(last)}</td>
        <td style="font-weight:700; color:${pl===null?'#334155':(pl>=0?'#15803d':'#b91c1c')}">${pl===null?'-':fmtPct(pl)}</td>
        <td>${row.note||''}</td>
        <td class="actions">
          <button class="btn" data-act="edit" data-idx="${idx}">${dict.edit}</button>
          <button class="btn" data-act="del" data-idx="${idx}">${dict.del}</button>
        </td>`;
      $tbody.appendChild(tr);
    });
    $totals.textContent = (dict.totals||'').replace('{n}', data.length);
  }

  function addPosition(){
    const symbol = document.getElementById('posSymbol').value.trim() || getCurrentSymbol();
    const avg = number(document.getElementById('posAvg').value);
    const note = document.getElementById('posNote').value.trim();
    if(!symbol || avg<=0){
      alert(currentLang==='en' ? 'Please fill symbol and avg. price.' : 'Preencha símbolo e preço médio.');
      return;
    }
    const data = readPositions();
    data.push({symbol, avg, note});
    writePositions(data);
    document.getElementById('posSymbol').value='';
    document.getElementById('posAvg').value='';
    document.getElementById('posNote').value='';
    refreshPrices();
  }

  document.getElementById('addPosBtn').addEventListener('click', addPosition);
  document.getElementById('clearAllBtn').addEventListener('click', ()=>{
    if(confirm(currentLang==='en' ? 'Clear all positions?' : 'Limpar todas as posições?')){
      writePositions([]); renderPositions({}); quoteStatus.textContent=''; lastRefreshEl.textContent='';
    }
  });
  document.getElementById('exportBtn').addEventListener('click', ()=>{
    const rows = readPositions();
    const header = ['symbol','avg','note'];
    const csv = [header.join(',')].concat(rows.map(r=> `${r.symbol},${r.avg},"${(r.note||'').replace(/"/g,'""')}"`)).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'positions.csv'; a.click();
    URL.revokeObjectURL(url);
  });

  document.querySelector('#posTable tbody').addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const act = btn.getAttribute('data-act');
    const idx = parseInt(btn.getAttribute('data-idx'),10);
    const data = readPositions();
    if(act==='del'){
      data.splice(idx,1); writePositions(data); refreshPrices();
    }else if(act==='edit'){
      const row = data[idx];
      const symbol = prompt(currentLang==='en'?'Symbol:':'Símbolo:', row.symbol) || row.symbol;
      const avg = parseFloat(prompt(currentLang==='en'?'Avg. price:':'Preço médio:', row.avg)) || row.avg;
      const note = prompt(currentLang==='en'?'Note:':'Observação:', row.note||'') || row.note;
      data[idx] = {symbol, avg, note};
      writePositions(data); refreshPrices();
    }else if(act==='show'){
      const row = data[idx];
      document.getElementById('chartSymbolInput').value = row.symbol;
      loadChart(row.symbol);
    }
  });

  // ====== PREÇOS via seu Worker ======
  async function refreshPrices(){
    const dict = I18N[currentLang] || I18N.pt;
    const rows = readPositions();
    const symbols = [...new Set(rows.map(r => (r.symbol||'').trim()).filter(Boolean))];

    if (symbols.length === 0) {
      renderPositions({});
      const msg = currentLang==='en' ? 'Add a position to fetch prices.' : 'Adicione uma posição para buscar preços.';
      quoteStatus.textContent = msg;
      lastRefreshEl.textContent = '';
      return;
    }

    quoteStatus.textContent = (currentLang==='en' ? 'Updating prices…' : 'Atualizando preços…');

    try{
      const url = QUOTE_API_BASE + "?symbols=" + encodeURIComponent(symbols.join(','));
      const resp = await fetch(url, { cache: 'no-store' });
      if(!resp.ok) throw new Error('HTTP ' + resp.status);
      const json = await resp.json();
      const map = json?.prices || {};

      // monta mapa somente dos símbolos da tabela
      const out = {};
      rows.forEach(r => {
        const v = map[r.symbol];
        out[r.symbol] = (typeof v === 'number') ? v : null;
      });

      renderPositions(out);
      quoteStatus.textContent = '';
      lastRefreshEl.textContent = (currentLang==='en' ? 'Last update: ' : 'Última atualização: ') +
        new Date().toLocaleString(currentLang==='en'?'en-US':'pt-BR', {hour12:false});
      writeCache(out);
    }catch(e){
      console.error('quotes error', e);
      const cache = readCache();
      renderPositions(cache);
      quoteStatus.textContent = (currentLang==='en' ? 'Could not update quotes.' : 'Não foi possível atualizar as cotações.');
    }
  }

  // Inicializações
  document.getElementById('y').textContent = new Date().getFullYear();
  applyI18n();
  loadChart(DEFAULT_SYMBOL);
  refreshPrices();

  // Botão Atualizar
  document.getElementById('refreshBtn').addEventListener('click', refreshPrices);

  // Auto refresh das cotações
  const AUTO_REFRESH_MS = 120000; // 2 min
  setInterval(refreshPrices, AUTO_REFRESH_MS);
});
</script>
