<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> AI Investimentos - Dicas para familia e amigos</title>
  <meta name="description" content="Site com dicas, gr√°fico TradingView, alertas embutidos e minhas posi√ß√µes com P/L %." />
  <link rel="preconnect" href="https://s3.tradingview.com" crossorigin>
  <style>
    :root{ --bg:#f8fafc; --panel:#ffffff; --ink:#0f172a; --muted:#475569; --acc:#0ea5e9; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--ink)}
    a{color:var(--acc);text-decoration:none}
    .wrap{max-width:1150px;margin:0 auto;padding:28px}
    header{display:flex;gap:20px;align-items:center;justify-content:space-between;margin-bottom:22px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:10px;background:conic-gradient(from 210deg,#22d3ee,#6366f1,#22d3ee);box-shadow:0 6px 20px rgba(34,211,238,.25)}
    h1{font-size:clamp(18px,3.2vw,26px);margin:0}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--panel);border:1px solid rgba(0,0,0,.1);border-radius:16px;padding:18px}
    h2{margin:0 0 10px 0;font-size:18px}
    p{color:var(--muted);line-height:1.6;margin:8px 0}
    .tips li{margin:8px 0;color:var(--ink)}
    footer{margin:28px 0 8px 0;text-align:center;color:var(--muted);font-size:12px}
    .btn{cursor:pointer;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:#fff;padding:8px 12px}
    .btn:hover{background:#f1f5f9}
    input,select,textarea{font:inherit;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#fff;color:var(--ink);padding:10px 12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.08);text-align:left}
    th{font-size:13px;color:#334155}
    .status{font-size:12px;color:#475569;margin-top:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#0369a1;background:#e0f2fe;border:1px solid #bae6fd;border-radius:999px;padding:2px 8px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1 data-i18n="title" id="siteTitle">Dicas AI Investimentos para familia e amigos</h1>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="langToggle" class="btn" title="Switch language">üáßüá∑/üá∫üá∏ <span id="langLabel">PT</span></button>
      </div>
    </header>

    <section class="card">
      <h2 data-i18n="quick_tips">Dicas r√°pidas</h2>
      <ul class="tips">
        <li>Todos os dias o <strong>Agente</strong> enviar√° os alertas <strong>ap√≥s o fechamento</strong> da bolsa de Wall Street.</li>
        <li>Alertas de <strong>compra (curto prazo)</strong> buscam ganho de <strong>5%</strong>; de <strong>longo prazo</strong> buscam <strong>10%</strong>.</li>
        <li>Fique ligado aos <strong>alertas de venda</strong>.</li>
      </ul>
    </section>

    <div class="grid" style="margin-top:16px">
      <!-- TradingView -->
      <section class="card" style="grid-column: span 8">
        <h2 data-i18n="chart_title">Gr√°fico (TradingView)</h2>
        <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px;margin:0 0 10px 0">
          <input id="chartSymbolInput" placeholder="Ex.: NASDAQ:NVDA ou BMFBOVESPA:PETR4" style="grid-column:span 6" />
          <button id="setChartBtn" class="btn" style="grid-column:span 2" data-i18n="set_symbol">Carregar s√≠mbolo</button>
          <button id="addFromChartBtn" class="btn" style="grid-column:span 2" data-i18n="add_from_chart">Adicionar √† lista</button>
          <a id="openTV" class="btn" style="grid-column:span 2;text-align:center" href="https://www.tradingview.com/chart/" target="_blank" rel="noopener" data-i18n="open_tv">Abrir no TradingView</a>
        </div>
        <div id="tradingview_chart" style="height:520px;width:100%"></div>
        <p class="status" id="tvStatus"></p>
      </section>

      <!-- Alertas (iframe) -->
      <section class="card" style="grid-column: span 4">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <h2 data-i18n="alerts_title">Alertas (janela interna)</h2>
          <span class="badge">‚ö° webhook</span>
        </div>
        <iframe
          src="https://shiny-sea-44d3.rafaelnm.workers.dev/"
          id="alertsFrame"
          title="Alertas ‚Äì Cloudflare Worker"
          loading="lazy"
          referrerpolicy="no-referrer"
          style="width:100%;height:520px;border:1px solid rgba(0,0,0,.1);border-radius:12px;background:#ffffff;color:#000000;">
        </iframe>
        <details style="margin-top:8px"><summary class="status">Se a janela n√£o aparecer</summary>
          <p class="status">No Worker: remova <code>X-Frame-Options</code> e permita <code>frame-ancestors</code> no CSP (inclua seu dom√≠nio do GitHub Pages).</p>
        </details>
      </section>
    </div>
<!-- Opini√£o da AI (T√©cnico + Analistas) -->
    <section class="card" id="ai-opinion" style="margin-top:16px">
      <h2 id="aiTitle">Opini√£o da AI (T√©cnico + Analistas)</h2>
      <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px;margin:8px 0 12px 0">
        <input id="aiSymbolInput" placeholder="Ex.: NASDAQ:AMZN ou AMZN" style="grid-column:span 6" />
        <button id="aiAnalyzeBtn" class="btn" style="grid-column:span 3">Analisar</button>
        <button id="aiUseChartBtn" class="btn" style="grid-column:span 3">Usar s√≠mbolo do gr√°fico</button>
      </div>
      <div id="aiResult" class="card" style="background:#f8fafc;border:1px dashed rgba(0,0,0,.1);min-height:90px"></div>
      <p class="status" id="aiStatus"></p>
    </section>

    <!-- Minhas posi√ß√µes (p√∫blicas + locais) -->
    <section class="card" style="margin-top:16px">
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap">
        <h2 data-i18n="positions_title">Minhas posi√ß√µes</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <span class="badge" title="Visitantes veem essas posi√ß√µes">üåê P√∫blico</span>
          <button id="loadPublicBtn" class="btn">Atualizar p√∫blicas</button>
          <button id="publishBtn" class="btn" title="Enviar posi√ß√µes locais para o servidor (admin)">Publicar minhas posi√ß√µes (admin)</button>
        </div>
      </div>

      <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px;margin:8px 0 12px 0">
        <input id="posSymbol" placeholder="Ex.: NASDAQ:NVDA ou BMFBOVESPA:PETR4" style="grid-column:span 6" />
        <input id="posAvg" type="number" inputmode="decimal" step="0.01" placeholder="Pre√ßo m√©dio" style="grid-column:span 3" />
        <input id="posNote" placeholder="Observa√ß√£o (opcional)" style="grid-column:span 3" />
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="addPosBtn" class="btn" data-i18n="add_position">Adicionar posi√ß√£o (local)</button>
        <button id="refreshBtn" class="btn" data-i18n="refresh">Atualizar pre√ßos</button>
        <button id="clearAllBtn" class="btn" data-i18n="clear_all">Limpar locais</button>
        <button id="exportBtn" class="btn" data-i18n="export_csv">Exportar CSV (locais)</button>
      </div>
      <p class="status" id="quoteStatus"></p>
      <div style="overflow:auto;margin-top:12px">
        <table id="posTable" aria-label="positions">
          <thead>
            <tr>
              <th data-i18n="th_symbol">S√≠mbolo</th>
              <th data-i18n="th_avg">Pre√ßo m√©dio</th>
              <th data-i18n="th_last">Pre√ßo atual</th>
              <th data-i18n="th_pl">P/L %</th>
              <th data-i18n="th_note">Obs.</th>
              <th data-i18n="th_actions">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="totals" class="status" style="margin-top:10px"></p>
      <p id="lastRefresh" class="status"></p>
    </section>

    <!-- Ticker global no final da p√°gina -->
    <section class="card" style="margin-top:16px">
      <h2>Mercados Globais &amp; Magnificent 7</h2>
      <div class="tradingview-widget-container">
        <div class="tradingview-widget-container__widget"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
          {
            "symbols": [
              {"proName": "FOREXCOM:US30",  "title": "Dow Jones"},
              {"proName": "NASDAQ:IXIC", "title": "Nasdaq 100"},
              {"proName": "SP:SPCFD", "title": "S&P 500"},
              {"proName": "BMFBOVESPA:IBOV", "title": "Ibovespa"},
              {"proName": "FOREXCOM:EU50",  "title": "Euro Stoxx 50"},
              {"proName": "FOREXCOM:UK100", "title": "FTSE 100"},

              {"proName": "NASDAQ:AAPL",  "title": "Apple"},
              {"proName": "NASDAQ:MSFT",  "title": "Microsoft"},
              {"proName": "NASDAQ:GOOGL", "title": "Alphabet"},
              {"proName": "NASDAQ:AMZN",  "title": "Amazon"},
              {"proName": "NASDAQ:NVDA",  "title": "NVIDIA"},
              {"proName": "NASDAQ:META",  "title": "Meta"},
              {"proName": "NASDAQ:TSLA",  "title": "Tesla"}
            ],
            "showSymbolLogo": true,
            "isTransparent": false,
            "displayMode": "adaptive",
            "colorTheme": "light"
          }
        </script>
      </div>
    </section>

    <footer>¬© <span id="y"></span> ‚Ä¢ <span data-i18n="disclaimer">Site educacional, n√£o √© recomenda√ß√£o de investimento.</span></footer>
  </div>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
  // ===================== CONFIG =====================
  const API_BASE = "https://shiny-sea-44d3.rafaelnm.workers.dev";
  const QUOTE_API = API_BASE + "/quotes";
  const POS_API   = API_BASE + "/positions";

  // ===================== I18N =====================
  const I18N = {
    pt:{ title:"AI Invest - Dicas para familia e amigos", quick_tips:"Dicas r√°pidas",
      tip1:"Defina <strong>entrada, stop e alvo</strong> antes de executar.",
      tip2:"Use <strong>gest√£o de risco</strong> por posi√ß√£o e por carteira.",
      tip3:"Combine <strong>fundamental + t√©cnico</strong> para decis√µes mais s√≥lidas.",
      chart_title:"Gr√°fico (TradingView)", alerts_title:"Alertas (janela interna)",
      ticker_title:"Ticker de Cota√ß√µes", positions_title:"Minhas posi√ß√µes",
      add_position:"Adicionar posi√ß√£o", clear_all:"Limpar tudo", export_csv:"Exportar CSV",
      th_symbol:"S√≠mbolo", th_avg:"Pre√ßo m√©dio", th_last:"Pre√ßo atual", th_pl:"P/L %",
      th_note:"Obs.", th_actions:"A√ß√µes", disclaimer:"Site educacional, n√£o √© recomenda√ß√£o de investimento.",
      edit:"Editar", del:"Excluir", totals:"Total de posi√ß√µes: {n}", refresh:"Atualizar pre√ßos",
      set_symbol:"Carregar s√≠mbolo", add_from_chart:"Adicionar √† lista", open_tv:"Abrir no TradingView",
      ai_title:"Opini√£o da AI (T√©cnico + Analistas)", ai_analyze:"Analisar", ai_use_chart:"Usar s√≠mbolo do gr√°fico",
      ai_decision:"Decis√£o", ai_score:"Score", ai_reasons:"Motivos", ai_technicals:"T√©cnicos", ai_analysts:"Analistas",
      ai_buy:"Comprar", ai_hold:"Manter", ai_sell:"Vender", ai_last_update:"√öltima an√°lise"
    },
    en:{ title:"AI Invest - TIP for Family and Friends", quick_tips:"Quick tips",
      tip1:"Define <strong>entry, stop and target</strong> before executing.",
      tip2:"Use <strong>risk management</strong> per position and portfolio.",
      tip3:"Combine <strong>fundamental + technical</strong> for stronger decisions.",
      chart_title:"Chart (TradingView)", alerts_title:"Alerts (embedded window)",
      ticker_title:"Quotes Ticker", positions_title:"My positions", add_position:"Add position",
      clear_all:"Clear all", export_csv:"Export CSV", th_symbol:"Symbol", th_avg:"Avg. price",
      th_last:"Last price", th_pl:"P/L %", th_note:"Note", th_actions:"Actions",
      disclaimer:"Educational site, not investment advice.", edit:"Edit", del:"Delete",
      totals:"Total positions: {n}", refresh:"Refresh prices", set_symbol:"Load symbol",
      add_from_chart:"Add from chart", open_tv:"Open on TradingView",
      ai_title:"AI Opinion (Technical + Analysts)", ai_analyze:"Analyze", ai_use_chart:"Use chart symbol",
      ai_decision:"Decision", ai_score:"Score", ai_reasons:"Reasons", ai_technicals:"Technicals", ai_analysts:"Analysts",
      ai_buy:"Buy", ai_hold:"Hold", ai_sell:"Sell", ai_last_update:"Last analysis"
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    // ===== idioma =====
    function detectLang(){ const nav = navigator.language || 'pt-BR'; return String(nav).toLowerCase().startsWith('en') ? 'en' : 'pt'; }
    let currentLang = (localStorage.getItem('lang') || detectLang());
    const langLabel = document.getElementById('langLabel');
    function applyI18n(){
      const dict = I18N[currentLang] || I18N.pt;
      document.documentElement.lang = currentLang === 'en' ? 'en' : 'pt-br';
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(dict[key]) el.innerHTML = dict[key];
      });
      langLabel.textContent = currentLang.toUpperCase();
      loadChart(getCurrentSymbol(), currentLang === 'en' ? 'en' : 'br');
      renderPositions(latestQuotesMap);
    }
    document.getElementById('langToggle').addEventListener('click', ()=>{
      currentLang = currentLang === 'en' ? 'pt' : 'en'; localStorage.setItem('lang', currentLang); applyI18n();
    });

    // ===================== TradingView =====================
    const DEFAULT_SYMBOL = 'NASDAQ:AAPL';
    let tvWidgetInstance;
    function getCurrentSymbol(){ return window.__CURRENT_SYMBOL || DEFAULT_SYMBOL; }
    function setCurrentSymbol(s){ window.__CURRENT_SYMBOL = s; }
    function loadChart(symbol, locale){
      const tvStatus = document.getElementById('tvStatus');
      try{
        const loc = locale || (currentLang === 'en' ? 'en' : 'br');
        const s = (symbol || DEFAULT_SYMBOL).trim();
        setCurrentSymbol(s);
        if(tvWidgetInstance && typeof tvWidgetInstance.remove === 'function'){ tvWidgetInstance.remove(); }
        tvWidgetInstance = new TradingView.widget({
          autosize:true, symbol:s, interval:"60", timezone:"Etc/UTC", theme:"light", style:"1", locale:loc,
          enable_publishing:false, container_id:"tradingview_chart", withdateranges:true, allow_symbol_change:true
        });
        document.getElementById('openTV').href = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(s)}`;
        const input = document.getElementById('chartSymbolInput'); if(input && !input.value) input.value = s;
        tvStatus.textContent = '';
      }catch(e){ tvStatus.textContent = (currentLang==='en'?'Could not load chart now.':'N√£o foi poss√≠vel carregar o gr√°fico agora.'); console.error(e); }
    }
    document.getElementById('setChartBtn').addEventListener('click', ()=>{
      const s = document.getElementById('chartSymbolInput').value.trim(); if(!s){ alert(currentLang==='en'?'Enter a symbol':'Informe um s√≠mbolo'); return; } loadChart(s);
    });
    document.getElementById('addFromChartBtn').addEventListener('click', ()=>{
      document.getElementById('posSymbol').value = getCurrentSymbol(); document.getElementById('posAvg').focus();
    });
    // ===================== Opini√£o da AI =====================
    const AI_API = API_BASE + "/analyze"; // requer endpoint no Worker
    function aiDict(){ return (document.documentElement.lang==='en') ? I18N.en : I18N.pt; }
    function renderAIResult(payload){
      const d = aiDict();
      const box = document.getElementById('aiResult');
      if(!payload || typeof payload !== 'object'){ box.innerHTML = '<p class="status">'+(d.ai_last_update+': ‚Äî')+'</p>'; return; }
      const dec = String(payload.decision||'').toUpperCase();
      const mapLabel = { BUY:d.ai_buy, HOLD:d.ai_hold, SELL:d.ai_sell };
      const color = dec==='BUY' ? '#15803d' : (dec==='SELL' ? '#b91c1c' : '#334155');
      const score = (typeof payload.score==='number') ? Math.round(payload.score) : null;
      const tech = payload.technicals||{}; const an = payload.analysts||{}; const reasons = payload.reasons||[];
      box.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span class="badge" style="background:#f1f5f9;border-color:#e2e8f0;color:${color}"><strong>${d.ai_decision}:</strong> ${mapLabel[dec]||dec}</span>
          ${score!==null?`<span class="badge"><strong>${d.ai_score}:</strong> ${score}/100</span>`:''}
        </div>
        <div style="display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:10px">
          <div class="card" style="grid-column:span 6">
            <h3 style="margin:0 0 6px 0">${d.ai_technicals}</h3>
            <ul style="margin:0;padding-left:18px">
              <li>SMA50: <strong>${tech.sma50??'-'}</strong> ¬∑ SMA200: <strong>${tech.sma200??'-'}</strong></li>
              <li>RSI14: <strong>${tech.rsi??'-'}</strong></li>
              <li>MACD: <strong>${tech.macd?.macd??'-'}</strong> ¬∑ Signal: <strong>${tech.macd?.signal??'-'}</strong></li>
            </ul>
          </div>
          <div class="card" style="grid-column:span 6">
            <h3 style="margin:0 0 6px 0">${d.ai_analysts}</h3>
            <ul style="margin:0;padding-left:18px">
              <li>Mean: <strong>${an.mean??'-'}</strong></li>
              <li>Trend: ${an.trend ? `<strong>buy ${an.trend.buy||0}</strong> ¬∑ hold ${an.trend.hold||0} ¬∑ sell ${an.trend.sell||0}` : '-'}</li>
            </ul>
          </div>
        </div>
        ${reasons.length?`<div style="margin-top:8px"><strong>${d.ai_reasons}:</strong><ul style="margin:6px 0;padding-left:18px">${reasons.map(r=>`<li>${r}</li>`).join('')}</ul></div>`:''}
      `;
    }
    async function runAIAnalysis(symbol){
      const d = aiDict();
      const aiStatus = document.getElementById('aiStatus');
      aiStatus.textContent = d.refresh+"‚Ä¶";
      try{
        const resp = await fetch(AI_API + "?symbol=" + encodeURIComponent(symbol), { cache:'no-store' });
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const json = await resp.json();
        renderAIResult(json);
        aiStatus.textContent = d.ai_last_update+': '+new Date().toLocaleString(document.documentElement.lang==='en'?'en-US':'pt-BR',{hour12:false});
      }catch(e){
        console.error('AI analyze error', e);
        aiStatus.textContent = (document.documentElement.lang==='en'?'Could not analyze now.':'N√£o foi poss√≠vel analisar agora.');
      }
    }
    document.getElementById('aiAnalyzeBtn').addEventListener('click', ()=>{
      const s = document.getElementById('aiSymbolInput').value.trim() || getCurrentSymbol();
      if(!s) return; runAIAnalysis(s);
    });
    document.getElementById('aiUseChartBtn').addEventListener('click', ()=>{
      const s = getCurrentSymbol();
      document.getElementById('aiSymbolInput').value = s;
    });

    // Ajusta textos da se√ß√£o ao trocar idioma
    const oldApplyI18n = applyI18n; // keep ref if exists
    applyI18n = function(){
      // chama a vers√£o original
      oldApplyI18n();
      const d = aiDict();
      const titleEl = document.getElementById('aiTitle'); if(titleEl) titleEl.textContent = d.ai_title;
      const b1 = document.getElementById('aiAnalyzeBtn'); if(b1) b1.textContent = d.ai_analyze;
      const b2 = document.getElementById('aiUseChartBtn'); if(b2) b2.textContent = d.ai_use_chart;
    };

    // ===================== Posi√ß√µes: p√∫blico + local =====================
    const posKeyLocal = 'positions_v4_pl_only_autorefresh';
    const cacheKey = 'positions_last_prices_cache_v1';
    const $tbody = document.querySelector('#posTable tbody');
    const $totals = document.getElementById('totals');
    const quoteStatus = document.getElementById('quoteStatus');
    const lastRefreshEl = document.getElementById('lastRefresh');

    let publicPositions = [];
    function readPositionsLocal(){ try{ return JSON.parse(localStorage.getItem(posKeyLocal)) || []; }catch{ return []; } }
    function writePositionsLocal(data){ localStorage.setItem(posKeyLocal, JSON.stringify(data)); }
    function readCache(){ try{ return JSON.parse(localStorage.getItem(cacheKey)) || {}; }catch{ return {}; } }
    function writeCache(obj){ localStorage.setItem(cacheKey, JSON.stringify(obj||{})); }
    function number(v){ return isNaN(parseFloat(v)) ? 0 : parseFloat(v); }
    function fmt(n, d=2){ if(n===null||n===undefined||isNaN(n)) return '-'; return Number(n).toFixed(d); }
    function fmtPct(n){ if(n===null||n===undefined||isNaN(n)) return '-'; return (n>=0?'+':'')+Number(n).toFixed(2)+'%'; }

    function getAllPositions(){
      const locals = readPositionsLocal();
      return [...publicPositions.map(p => ({...p, __public:true})), ...locals.map(p => ({...p, __public:false}))];
    }

    let latestQuotesMap = {};
    function renderPositions(quotesMap={}){
      latestQuotesMap = quotesMap;
      const dict = I18N[currentLang] || I18N.pt;
      const data = getAllPositions();
      $tbody.innerHTML = '';
      data.forEach((row, idx)=>{
        const last = (typeof quotesMap[row.symbol] === 'number') ? quotesMap[row.symbol] : null;
        const pl = (last && row.avg>0) ? ((last/row.avg-1)*100) : null;
        const badge = row.__public ? ' <span class="badge" title="Vis√≠vel para todos">üåê</span>' : '';
        const actions = row.__public
          ? '<span class="status">‚Äî</span>'
          : `<button class="btn" data-act="edit" data-idx="${idx}">${dict.edit}</button>
             <button class="btn" data-act="del" data-idx="${idx}">${dict.del}</button>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><button class="btn" data-act="show" data-idx="${idx}" title="Mostrar no gr√°fico">${row.symbol}</button>${badge}</td>
          <td>${fmt(row.avg)}</td>
          <td>${last===null?'-':fmt(last)}</td>
          <td style="font-weight:700; color:${pl===null?'#334155':(pl>=0?'#15803d':'#b91c1c')}">${pl===null?'-':fmtPct(pl)}</td>
          <td>${row.note||''}</td>
          <td class="actions">${actions}</td>`;
        $tbody.appendChild(tr);
      });
      $totals.textContent = (dict.totals||'').replace('{n}', data.length);
    }

    async function loadPublicPositions(){
      try{
        const r = await fetch(POS_API, { cache:'no-store' });
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        publicPositions = Array.isArray(j.positions) ? j.positions : [];
      }catch(e){
        console.error('loadPublicPositions', e);
        publicPositions = [];
      }
      await refreshPrices();
    }

    function addPositionLocal(){
      const symbol = document.getElementById('posSymbol').value.trim() || getCurrentSymbol();
      const avg = number(document.getElementById('posAvg').value);
      const note = document.getElementById('posNote').value.trim();
      if(!symbol || avg<=0){
        alert(document.documentElement.lang==='en' ? 'Please fill symbol and avg. price.' : 'Preencha s√≠mbolo e pre√ßo m√©dio.');
        return;
      }
      const data = readPositionsLocal();
      data.push({symbol, avg, note});
      writePositionsLocal(data);
      document.getElementById('posSymbol').value='';
      document.getElementById('posAvg').value='';
      document.getElementById('posNote').value='';
      refreshPrices();
    }

    async function publishLocalPositions(){
      const token = localStorage.getItem('admin_token') || prompt('Admin token (Bearer):');
      if(!token){ return; }
      localStorage.setItem('admin_token', token);
      const list = readPositionsLocal();
      try{
        const r = await fetch(POS_API, {
          method:'POST',
          headers:{ 'content-type':'application/json', 'authorization':'Bearer '+token },
          body: JSON.stringify({ positions: list })
        });
        if(!r.ok){
          const t = await r.text().catch(()=> '');
          throw new Error(`HTTP ${r.status} ${t}`);
        }
        alert('Posi√ß√µes publicadas com sucesso!');
        await loadPublicPositions();
      }catch(e){
        console.error('publishLocalPositions', e);
        alert('Falha ao publicar. Verifique o token em ADMIN_TOKEN no Worker.');
      }
    }

    document.getElementById('addPosBtn').addEventListener('click', addPositionLocal);
    document.getElementById('publishBtn').addEventListener('click', publishLocalPositions);
    document.getElementById('loadPublicBtn').addEventListener('click', loadPublicPositions);

    document.getElementById('clearAllBtn').addEventListener('click', ()=>{
      if(confirm(document.documentElement.lang==='en' ? 'Clear all LOCAL positions?' : 'Limpar as posi√ß√µes LOCAIS?')){
        writePositionsLocal([]); renderPositions(latestQuotesMap);
      }
    });
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const rows = readPositionsLocal();
      const header = ['symbol','avg','note'];
      const csv = [header.join(',')].concat(rows.map(r=> `${r.symbol},${r.avg},"${(r.note||'').replace(/"/g,'""')}"`)).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'positions_local.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    document.querySelector('#posTable tbody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const act = btn.getAttribute('data-act');
      const idx = parseInt(btn.getAttribute('data-idx'),10);
      const data = getAllPositions();
      const row = data[idx];
      if(act==='del'){
        if(row.__public){ alert('Posi√ß√£o p√∫blica n√£o pode ser apagada por aqui. Use o bot√£o "Publicar..." para sobrescrever.'); return; }
        const locals = readPositionsLocal();
        const found = locals.findIndex(x=> x.symbol===row.symbol && x.avg===row.avg && x.note===row.note);
        if(found>-1){ locals.splice(found,1); writePositionsLocal(locals); refreshPrices(); }
      }else if(act==='edit'){
        if(row.__public){ alert('Posi√ß√£o p√∫blica n√£o pode ser editada por aqui. Edite local e publique.'); return; }
        const locals = readPositionsLocal();
        const found = locals.findIndex(x=> x.symbol===row.symbol && x.avg===row.avg && x.note===row.note);
        if(found===-1) return;
        const symbol = prompt(document.documentElement.lang==='en'?'Symbol:':'S√≠mbolo:', row.symbol) || row.symbol;
        const avg = parseFloat(prompt(document.documentElement.lang==='en'?'Avg. price:':'Pre√ßo m√©dio:', row.avg)) || row.avg;
        const note = prompt(document.documentElement.lang==='en'?'Note:':'Observa√ß√£o:', row.note||'') || row.note;
        locals[found] = {symbol, avg, note};
        writePositionsLocal(locals); refreshPrices();
      }else if(act==='show'){
        document.getElementById('chartSymbolInput').value = row.symbol; loadChart(row.symbol);
      }
    });

    // ===================== Pre√ßos via Worker =====================
    async function refreshPrices(){
      const rows = getAllPositions();
      const symbols = [...new Set(rows.map(r => (r.symbol||'').trim()).filter(Boolean))];
      if (symbols.length === 0) {
        renderPositions({}); quoteStatus.textContent = (document.documentElement.lang==='en' ? 'No positions.' : 'Sem posi√ß√µes.');
        lastRefreshEl.textContent = ''; return;
      }
      quoteStatus.textContent = (document.documentElement.lang==='en' ? 'Updating prices‚Ä¶' : 'Atualizando pre√ßos‚Ä¶');
      try{
        const url = QUOTE_API + "?symbols=" + encodeURIComponent(symbols.join(','));
        const resp = await fetch(url, { cache: 'no-store' });
        if(!resp.ok) throw new Error('HTTP ' + resp.status);
        const json = await resp.json();
        const map = json?.prices || {};
        const out = {};
        rows.forEach(r => { const v = map[r.symbol]; out[r.symbol] = (typeof v === 'number') ? v : null; });
        renderPositions(out);
        quoteStatus.textContent = '';
        lastRefreshEl.textContent = (document.documentElement.lang==='en' ? 'Last update: ' : '√öltima atualiza√ß√£o: ') +
          new Date().toLocaleString(document.documentElement.lang==='en'?'en-US':'pt-BR', {hour12:false});
        writeCache(out);
      }catch(e){
        console.error('quotes error', e);
        renderPositions(readCache());
        quoteStatus.textContent = (document.documentElement.lang==='en' ? 'Could not update quotes.' : 'N√£o foi poss√≠vel atualizar as cota√ß√µes.');
      }
    }

    // ===================== Inicializa√ß√£o =====================
    document.getElementById('y').textContent = new Date().getFullYear();
    applyI18n();
    loadChart('NASDAQ:AAPL');
    loadPublicPositions();
    document.getElementById('refreshBtn').addEventListener('click', refreshPrices);
    setInterval(refreshPrices, 120000);
  });
  </script>
</body>
</html>
