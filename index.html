<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Investimentos - Dicas para familia e amigos</title>
  <meta name="description" content="Site com dicas, gr√°fico TradingView, alertas embutidos e minhas posi√ß√µes com P/L %." />
  <link rel="preconnect" href="https://s3.tradingview.com" crossorigin>
  <style>
    :root{ --bg:#f8fafc; --panel:#ffffff; --ink:#0f172a; --muted:#475569; --acc:#0ea5e9; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--ink)}
    a{color:var(--acc);text-decoration:none}
    .wrap{max-width:1150px;margin:0 auto;padding:28px}
    header{display:flex;gap:20px;align-items:center;justify-content:space-between;margin-bottom:22px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:10px;background:conic-gradient(from 210deg,#22d3ee,#6366f1,#22d3ee);box-shadow:0 6px 20px rgba(34,211,238,.25)}
    h1{font-size:clamp(18px,3.2vw,26px);margin:0}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--panel);border:1px solid rgba(0,0,0,.1);border-radius:16px;padding:18px}
    h2{margin:0 0 10px 0;font-size:18px}
    p{color:var(--muted);line-height:1.6;margin:8px 0}
    .tips li{margin:8px 0;color:var(--ink)}
    footer{margin:28px 0 8px 0;text-align:center;color:var(--muted);font-size:12px}
    .btn{cursor:pointer;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:#fff;padding:8px 12px}
    .btn:hover{background:#f1f5f9}
    input,select,textarea{font:inherit;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#fff;color:var(--ink);padding:10px 12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.08);text-align:left}
    th{font-size:13px;color:#334155}
    .status{font-size:12px;color:#475569;margin-top:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#0369a1;background:#e0f2fe;border:1px solid #bae6fd;border-radius:999px;padding:2px 8px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1 data-i18n="title" id="siteTitle">Dicas AI Investimentos para familia e amigos</h1>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="langToggle" class="btn" title="Switch language">üáßüá∑/üá∫üá∏ <span id="langLabel">PT</span></button>
      </div>
    </header>

    <!-- 1) Dicas r√°pidas -->
    <section class="card">
      <h2 data-i18n="quick_tips">Dicas r√°pidas</h2>
      <ul class="tips">
        <li data-i18n="quick_tip_1">Todos os dias o <strong>Agente</strong> enviar√° os alertas <strong>ap√≥s o fechamento</strong> da bolsa de Wall Street.</li>
        <li data-i18n="quick_tip_2">Alertas de <strong>compra (curto prazo)</strong> buscam ganho de <strong>5%</strong>; de <strong>longo prazo</strong> buscam <strong>10%</strong>.</li>
        <li data-i18n="quick_tip_3">Fique ligado aos <strong>alertas de venda</strong>.</li>
      </ul>
    </section>

    <!-- 2) Opini√£o da AI (com Grok) ao lado dos Alertas -->
    <div class="grid" style="margin-top:16px">
      <!-- Opini√£o da AI -->
      <section class="card" id="ai-opinion" style="grid-column: span 8">
        <h2 id="aiTitle" data-i18n="ai_title">Opini√£o da AI (T√©cnico + Analistas)</h2>
        <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px;margin:8px 0 12px 0">
          <input id="aiSymbolInput" data-i18n-ph="ph_ai_symbol" placeholder="Ex.: NASDAQ:AMZN ou AMZN" style="grid-column:span 6" />
          <button id="aiAnalyzeBtn" class="btn" style="grid-column:span 3" data-i18n="ai_analyze">Analisar</button>
          <button id="aiUseChartBtn" class="btn" style="grid-column:span 3" data-i18n="ai_use_chart">Usar s√≠mbolo do gr√°fico</button>
        </div>

        <!-- Resultado calculado pelo Worker (/analyze) -->
        <div id="aiResult" class="card" style="background:#f8fafc;border:1px dashed rgba(0,0,0,.1);min-height:90px"></div>

        <!-- Opini√£o extra via LLM (Grok / OpenRouter) -->
        <div id="grokBox" class="card" style="margin-top:10px;background:#fff7ed;border:1px solid #fed7aa">
          <h3 id="grokTitle" data-i18n="grok_title" style="margin:0 0 8px 0">Opini√£o extra da IA (Grok)</h3>
          <div id="grokOpinion" class="status">‚Äî</div>
        </div>

        <p class="status" id="aiStatus"></p>
      </section>

      <!-- Alertas -->
      <section class="card" style="grid-column: span 4">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <h2 data-i18n="alerts_title">Alertas</h2>
          <span class="badge" data-i18n="alerts_badge">‚ö° Agente</span>
        </div>
        <iframe
          src="https://shiny-sea-44d3.rafaelnm.workers.dev/"
          id="alertsFrame"
          title="Alertas ‚Äì Cloudflare Worker"
          loading="lazy"
          referrerpolicy="no-referrer"
          style="width:100%;height:520px;border:1px solid rgba(0,0,0,.1);border-radius:12px;background:#ffffff;color:#000000;">
        </iframe>
        <details style="margin-top:8px">
          <summary class="status" data-i18n="alerts_iframe_help_sum">Se a janela n√£o aparecer</summary>
          <p class="status" data-i18n="alerts_iframe_help_txt">
            No Worker: remova <code>X-Frame-Options</code> e permita <code>frame-ancestors</code> no CSP (inclua seu dom√≠nio do GitHub Pages).
          </p>
        </details>
      </section>
    </div>

    <!-- 3) Minhas posi√ß√µes -->
    <section class="card" style="margin-top:16px">
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap">
        <h2 data-i18n="positions_title">Minhas posi√ß√µes</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <span class="badge" title="Visitantes veem essas posi√ß√µes" data-i18n="public_badge">üåê P√∫blico</span>
          <button id="loadPublicBtn" class="btn" data-i18n="update_public">Atualizar p√∫blicas</button>
          <button id="publishBtn" class="btn" title="Enviar posi√ß√µes locais para o servidor (admin)" data-i18n="publish_admin">Publicar minhas posi√ß√µes (admin)</button>
        </div>
      </div>

      <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px;margin:8px 0 12px 0">
        <input id="posSymbol" data-i18n-ph="ph_pos_symbol" placeholder="Ex.: NASDAQ:NVDA ou BMFBOVESPA:PETR4" style="grid-column:span 6" />
        <input id="posAvg" type="number" inputmode="decimal" step="0.01" data-i18n-ph="ph_pos_avg" placeholder="Pre√ßo m√©dio" style="grid-column:span 3" />
        <input id="posNote" data-i18n-ph="ph_pos_note" placeholder="Observa√ß√£o (opcional)" style="grid-column:span 3" />
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="addPosBtn" class="btn" data-i18n="add_position">Adicionar posi√ß√£o (local)</button>
        <button id="refreshBtn" class="btn" data-i18n="refresh">Atualizar pre√ßos</button>
        <button id="clearAllBtn" class="btn" data-i18n="clear_all">Limpar locais</button>
        <button id="exportBtn" class="btn" data-i18n="export_csv">Exportar CSV (locais)</button>
      </div>
      <p class="status" id="quoteStatus"></p>
      <div style="overflow:auto;margin-top:12px">
        <table id="posTable" aria-label="positions">
          <thead>
            <tr>
              <th data-i18n="th_symbol">S√≠mbolo</th>
              <th data-i18n="th_avg">Pre√ßo m√©dio</th>
              <th data-i18n="th_last">Pre√ßo atual</th>
              <th data-i18n="th_pl">P/L %</th>
              <th data-i18n="th_note">Obs.</th>
              <th data-i18n="th_actions">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="totals" class="status" style="margin-top:10px"></p>
      <p id="lastRefresh" class="status"></p>
    </section>

    <!-- 4) Gr√°fico (TradingView) + novo quadro de dicas -->
    <div class="grid" style="margin-top:16px">
      <!-- Gr√°fico -->
      <section class="card" style="grid-column: span 8">
        <h2 data-i18n="chart_title">Gr√°fico (TradingView)</h2>
        <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px;margin:0 0 10px 0">
          <input id="chartSymbolInput" data-i18n-ph="ph_chart_symbol" placeholder="Ex.: NASDAQ:NVDA ou BMFBOVESPA:PETR4" style="grid-column:span 6" />
          <button id="setChartBtn" class="btn" style="grid-column:span 2" data-i18n="set_symbol">Carregar s√≠mbolo</button>
          <button id="addFromChartBtn" class="btn" style="grid-column:span 2" data-i18n="add_from_chart">Adicionar √† lista</button>
          <a id="openTV" class="btn" style="grid-column:span 2;text-align:center" href="https://www.tradingview.com/chart/" target="_blank" rel="noopener" data-i18n="open_tv">Abrir no TradingView</a>
        </div>
        <div id="tradingview_chart" style="height:520px;width:100%"></div>
        <p class="status" id="tvStatus"></p>
      </section>

      <!-- Novo quadro de dicas ao lado do gr√°fico -->
      <section class="card" style="grid-column: span 4">
        <h2 data-i18n="graph_tips_title">Boas pr√°ticas no gr√°fico</h2>
        <ul class="tips">
          <li data-i18n="gtip_1">Evite decis√µes com base em <strong>1 indicador</strong> apenas. Confirme com 2‚Äì3 sinais.</li>
          <li data-i18n="gtip_2">Observe a <strong>tend√™ncia (SMA50 x SMA200)</strong> antes do gatilho.</li>
          <li data-i18n="gtip_3">Prefira entrar com <strong>parcial</strong> e completar se o movimento confirmar.</li>
          <li data-i18n="gtip_4">Defina um <strong>stop t√©cnico</strong> e um <strong>alvo</strong> antes de clicar.</li>
          <li data-i18n="gtip_5">Revise not√≠cias/earnings que possam afetar o papel.</li>
        </ul>
      </section>
    </div>

    <!-- Ticker global no final da p√°gina -->
    <section class="card" style="margin-top:16px">
      <h2 data-i18n="global_ticker_title">Mercados Globais &amp; Magnificent 7</h2>
      <div class="tradingview-widget-container">
        <div class="tradingview-widget-container__widget"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
          {
            "symbols": [
              {"proName": "FOREXCOM:US30",  "title": "Dow Jones"},
              {"proName": "FOREXCOM:US100", "title": "Nasdaq 100"},
              {"proName": "FOREXCOM:US500", "title": "S&P 500"},
              {"proName": "BMFBOVESPA:IBOV", "title": "Ibovespa"},
              {"proName": "FOREXCOM:EU50",  "title": "Euro Stoxx 50"},
              {"proName": "FOREXCOM:UK100", "title": "FTSE 100"},

              {"proName": "NASDAQ:AAPL",  "title": "Apple"},
              {"proName": "NASDAQ:MSFT",  "title": "Microsoft"},
              {"proName": "NASDAQ:GOOGL", "title": "Alphabet"},
              {"proName": "NASDAQ:AMZN",  "title": "Amazon"},
              {"proName": "NASDAQ:NVDA",  "title": "NVIDIA"},
              {"proName": "NASDAQ:META",  "title": "Meta"},
              {"proName": "NASDAQ:TSLA",  "title": "Tesla"}
            ],
            "showSymbolLogo": true,
            "isTransparent": false,
            "displayMode": "adaptive",
            "colorTheme": "light"
          }
        </script>
      </div>
    </section>

    <footer>¬© <span id="y"></span> ‚Ä¢ <span id="disclaimer" data-i18n="disclaimer">Site educacional, n√£o √© recomenda√ß√£o de investimento.</span></footer>
  </div>

  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
  // ===================== CONFIG =====================
  const API_BASE = "https://shiny-sea-44d3.rafaelnm.workers.dev";
  const QUOTE_API = API_BASE + "/quotes";
  const POS_API   = API_BASE + "/positions";
  const AI_API    = API_BASE + "/analyze"; // Worker: /analyze
  // LLM (Grok via OpenRouter) est√° exposto no seu Worker como /kimi

  // ===================== I18N =====================
  const I18N = {
    pt:{
      title:"Dicas AI Investimentos para familia e amigos",
      quick_tips:"Dicas r√°pidas",
      quick_tip_1:"Todos os dias o <strong>Agente</strong> enviar√° os alertas <strong>ap√≥s o fechamento</strong> da bolsa de Wall Street.",
      quick_tip_2:"Alertas de <strong>compra (curto prazo)</strong> buscam ganho de <strong>5%</strong>; de <strong>longo prazo</strong> buscam <strong>10%</strong>.",
      quick_tip_3:"Fique ligado aos <strong>alertas de venda</strong>.",
      alerts_title:"Alertas",
      alerts_badge:"‚ö° Agente",
      alerts_iframe_help_sum:"Se a janela n√£o aparecer",
      alerts_iframe_help_txt:"No Worker: remova <code>X-Frame-Options</code> e permita <code>frame-ancestors</code> no CSP (inclua seu dom√≠nio do GitHub Pages).",
      positions_title:"Minhas posi√ß√µes",
      public_badge:"üåê P√∫blico",
      update_public:"Atualizar p√∫blicas",
      publish_admin:"Publicar minhas posi√ß√µes (admin)",
      ph_pos_symbol:"Ex.: NASDAQ:NVDA ou BMFBOVESPA:PETR4",
      ph_pos_avg:"Pre√ßo m√©dio",
      ph_pos_note:"Observa√ß√£o (opcional)",
      add_position:"Adicionar posi√ß√£o (local)",
      refresh:"Atualizar pre√ßos",
      clear_all:"Limpar locais",
      export_csv:"Exportar CSV (locais)",
      th_symbol:"S√≠mbolo", th_avg:"Pre√ßo m√©dio", th_last:"Pre√ßo atual", th_pl:"P/L %", th_note:"Obs.", th_actions:"A√ß√µes",
      chart_title:"Gr√°fico (TradingView)",
      ph_chart_symbol:"Ex.: NASDAQ:NVDA ou BMFBOVESPA:PETR4",
      set_symbol:"Carregar s√≠mbolo", add_from_chart:"Adicionar √† lista", open_tv:"Abrir no TradingView",
      graph_tips_title:"Boas pr√°ticas no gr√°fico",
      gtip_1:"Evite decis√µes com base em <strong>1 indicador</strong> apenas. Confirme com 2‚Äì3 sinais.",
      gtip_2:"Observe a <strong>tend√™ncia (SMA50 x SMA200)</strong> antes do gatilho.",
      gtip_3:"Prefira entrar com <strong>parcial</strong> e completar se o movimento confirmar.",
      gtip_4:"Defina um <strong>stop t√©cnico</strong> e um <strong>alvo</strong> antes de clicar.",
      gtip_5:"Revise not√≠cias/earnings que possam afetar o papel.",
      global_ticker_title:"Mercados Globais &amp; Magnificent 7",
      disclaimer:"Site educacional, n√£o √© recomenda√ß√£o de investimento - rafaelnm@gmail.com",

      // AI Opinion
      ai_title:"Opini√£o da AI (T√©cnico + Analistas)",
      ph_ai_symbol:"Ex.: NASDAQ:AMZN ou AMZN",
      ai_analyze:"Analisar",
      ai_use_chart:"Usar s√≠mbolo do gr√°fico",
      ai_decision:"Decis√£o", ai_score:"Score", ai_reasons:"Motivos", ai_technicals:"T√©cnicos", ai_analysts:"Analistas",
      ai_buy:"Comprar", ai_hold:"Manter", ai_sell:"Vender", ai_last_update:"√öltima an√°lise",

      // Grok
      grok_title:"Opini√£o extra da IA (Grok)",
      grok_thinking:"Consultando o Grok‚Ä¶",
      grok_error:"N√£o foi poss√≠vel obter a opini√£o do Grok agora.",

      // Misc
      no_positions:"Sem posi√ß√µes.",
      upd_prices:"Atualizando pre√ßos‚Ä¶",
      no_quotes:"N√£o foi poss√≠vel atualizar as cota√ß√µes.",
      could_not_analyze:"N√£o foi poss√≠vel analisar agora.",
      last_update:"√öltima atualiza√ß√£o: ",
      please_fill:"Preencha s√≠mbolo e pre√ßo m√©dio.",
      clear_locals_q:"Limpar as posi√ß√µes LOCAIS?"
    },
    en:{
      title:"AI Investing Tips for Family & Friends",
      quick_tips:"Quick tips",
      quick_tip_1:"Every day the <strong>Agent</strong> will send alerts <strong>after Wall Street close</strong>.",
      quick_tip_2:"<strong>Short-term buys</strong> target <strong>+5%</strong>; <strong>long-term</strong> target <strong>+10%</strong>.",
      quick_tip_3:"Watch out for <strong>sell alerts</strong>.",
      alerts_title:"Alerts",
      alerts_badge:"‚ö° Agent",
      alerts_iframe_help_sum:"If the window doesn't appear",
      alerts_iframe_help_txt:"On the Worker: remove <code>X-Frame-Options</code> and allow <code>frame-ancestors</code> in CSP (include your GitHub Pages domain).",
      positions_title:"My positions",
      public_badge:"üåê Public",
      update_public:"Refresh public",
      publish_admin:"Publish my positions (admin)",
      ph_pos_symbol:"e.g., NASDAQ:NVDA or BMFBOVESPA:PETR4",
      ph_pos_avg:"Average price",
      ph_pos_note:"Note (optional)",
      add_position:"Add position (local)",
      refresh:"Refresh prices",
      clear_all:"Clear local",
      export_csv:"Export CSV (local)",
      th_symbol:"Symbol", th_avg:"Avg. price", th_last:"Last price", th_pl:"P/L %", th_note:"Note", th_actions:"Actions",
      chart_title:"Chart (TradingView)",
      ph_chart_symbol:"e.g., NASDAQ:NVDA or BMFBOVESPA:PETR4",
      set_symbol:"Load symbol", add_from_chart:"Add from chart", open_tv:"Open on TradingView",
      graph_tips_title:"Chart best practices",
      gtip_1:"Don't rely on a <strong>single indicator</strong>. Confirm with 2‚Äì3 signals.",
      gtip_2:"Check the <strong>trend (SMA50 vs SMA200)</strong> before the trigger.",
      gtip_3:"Prefer a <strong>partial entry</strong> and add only if the move confirms.",
      gtip_4:"Define a <strong>technical stop</strong> and a <strong>target</strong> before clicking.",
      gtip_5:"Review news/earnings that may affect the stock.",
      global_ticker_title:"Global Markets &amp; Magnificent 7",
      disclaimer:"Educational site, not investment advice - rafaelnm@gmail.com",

      // AI Opinion
      ai_title:"AI Opinion (Technical + Analysts)",
      ph_ai_symbol:"e.g., NASDAQ:AMZN or AMZN",
      ai_analyze:"Analyze",
      ai_use_chart:"Use chart symbol",
      ai_decision:"Decision", ai_score:"Score", ai_reasons:"Reasons", ai_technicals:"Technicals", ai_analysts:"Analysts",
      ai_buy:"Buy", ai_hold:"Hold", ai_sell:"Sell", ai_last_update:"Last analysis",

      // Grok
      grok_title:"Extra AI Opinion (Grok)",
      grok_thinking:"Asking Grok‚Ä¶",
      grok_error:"Could not get Grok opinion now.",

      // Misc
      no_positions:"No positions.",
      upd_prices:"Updating prices‚Ä¶",
      no_quotes:"Could not update quotes.",
      could_not_analyze:"Could not analyze now.",
      last_update:"Last update: ",
      please_fill:"Please fill symbol and avg. price.",
      clear_locals_q:"Clear all LOCAL positions?"
    }
  };

  // Helper para pegar dicion√°rio ativo
  function dict(){ return (document.documentElement.lang==='en') ? I18N.en : I18N.pt; }

  // Aplica i18n em elementos com data-i18n e placeholders com data-i18n-ph
  function applyI18n(){
    const d = dict();
    // texto/HTML
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      if (d[key] !== undefined) el.innerHTML = d[key];
    });
    // placeholders
    document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
      const key = el.getAttribute('data-i18n-ph');
      if (d[key] !== undefined) el.setAttribute('placeholder', stripHTML(d[key]));
    });
    // html lang e label do bot√£o
    document.getElementById('langLabel').textContent = (document.documentElement.lang==='en') ? 'EN' : 'PT';

    // Atualiza chart (locale) e re-render da tabela para labels din√¢micos
    loadChart(getCurrentSymbol(), (document.documentElement.lang==='en') ? 'en' : 'br');
    renderPositions(latestQuotesMap);
  }

  function stripHTML(s){
    const tmp = document.createElement('div'); tmp.innerHTML = s; return tmp.textContent || tmp.innerText || '';
  }

  document.addEventListener('DOMContentLoaded', () => {
    // ===== idioma =====
    function detectLang(){ const nav = navigator.language || 'pt-BR'; return String(nav).toLowerCase().startsWith('en') ? 'en' : 'pt'; }
    const saved = localStorage.getItem('lang');
    document.documentElement.lang = saved ? (saved==='en'?'en':'pt-br') : (detectLang()==='en'?'en':'pt-br');
    applyI18n();

    document.getElementById('langToggle').addEventListener('click', ()=>{
      const now = (document.documentElement.lang==='en') ? 'pt-br' : 'en';
      document.documentElement.lang = now;
      localStorage.setItem('lang', now==='en'?'en':'pt');
      applyI18n();
    });

    // ===================== TradingView =====================
    const DEFAULT_SYMBOL = 'NASDAQ:NVDA';
    let tvWidgetInstance;
    window.getCurrentSymbol = function(){ return window.__CURRENT_SYMBOL || DEFAULT_SYMBOL; }
    function setCurrentSymbol(s){ window.__CURRENT_SYMBOL = s; }
    window.loadChart = function(symbol, locale){
      const tvStatus = document.getElementById('tvStatus');
      try{
        const loc = locale || (document.documentElement.lang==='en' ? 'en' : 'br');
        const s = (symbol || DEFAULT_SYMBOL).trim();
        setCurrentSymbol(s);
        if(tvWidgetInstance && typeof tvWidgetInstance.remove === 'function'){ tvWidgetInstance.remove(); }
        tvWidgetInstance = new TradingView.widget({
          autosize:true, symbol:s, interval:"60", timezone:"Etc/UTC", theme:"light", style:"1", locale:loc,
          enable_publishing:false, container_id:"tradingview_chart", withdateranges:true, allow_symbol_change:true
        });
        document.getElementById('openTV').href = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(s)}`;
        const input = document.getElementById('chartSymbolInput'); if(input && !input.value) input.value = s;
        tvStatus.textContent = '';
      }catch(e){
        tvStatus.textContent = (document.documentElement.lang==='en'? I18N.en.could_not_analyze : I18N.pt.could_not_analyze);
        console.error(e);
      }
    }
    document.getElementById('setChartBtn').addEventListener('click', ()=>{
      const s = document.getElementById('chartSymbolInput').value.trim();
      if(!s){ alert(dict().please_fill); return; }
      loadChart(s);
    });
    document.getElementById('addFromChartBtn').addEventListener('click', ()=>{
      document.getElementById('posSymbol').value = getCurrentSymbol(); document.getElementById('posAvg').focus();
    });

    // ===================== Opini√£o da AI (Worker /analyze + Grok via /kimi) =====================
    function renderAIResult(payload){
      const d = dict();
      const box = document.getElementById('aiResult');
      if(!payload || typeof payload !== 'object'){ box.innerHTML = '<p class="status">'+(d.ai_last_update+': ‚Äî')+'</p>'; return; }
      const dec = String(payload.decision||'').toUpperCase();
      const mapLabel = { BUY:d.ai_buy, HOLD:d.ai_hold, SELL:d.ai_sell };
      const color = dec==='BUY' ? '#15803d' : (dec==='SELL' ? '#b91c1c' : '#334155');
      const score = (typeof payload.score==='number') ? Math.round(payload.score) : null;
      const tech = payload.technicals||{}; const an = payload.analysts||{}; const reasons = payload.reasons||[];
      box.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span class="badge" style="background:#f1f5f9;border-color:#e2e8f0;color:${color}"><strong>${d.ai_decision}:</strong> ${mapLabel[dec]||dec}</span>
          ${score!==null?`<span class="badge"><strong>${d.ai_score}:</strong> ${score}/100</span>`:''}
        </div>
        <div style="display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:10px">
          <div class="card" style="grid-column:span 6">
            <h3 style="margin:0 0 6px 0">${d.ai_technicals}</h3>
            <ul style="margin:0;padding-left:18px">
              <li>SMA50: <strong>${tech.sma50??'-'}</strong> ¬∑ SMA200: <strong>${tech.sma200??'-'}</strong></li>
              <li>RSI14: <strong>${tech.rsi??'-'}</strong></li>
              <li>MACD: <strong>${tech.macd?.macd??'-'}</strong> ¬∑ Signal: <strong>${tech.macd?.signal??'-'}</strong></li>
            </ul>
          </div>
          <div class="card" style="grid-column:span 6">
            <h3 style="margin:0 0 6px 0">${d.ai_analysts}</h3>
            <ul style="margin:0;padding-left:18px">
              <li>Mean: <strong>${an.mean??'-'}</strong></li>
              <li>Trend: ${an.trend ? `<strong>buy ${an.trend.buy||0}</strong> ¬∑ hold ${an.trend.hold||0} ¬∑ sell ${an.trend.sell||0}` : '-'}</li>
            </ul>
          </div>
        </div>
        ${reasons.length?`<div style="margin-top:8px"><strong>${d.ai_reasons}:</strong><ul style="margin:6px 0;padding-left:18px">${reasons.map(r=>`<li>${r}</li>`).join('')}</ul></div>`:''}
      `;
    }

    function buildGrokMessages(symbol, analyzePayload){
      const isEN = (document.documentElement.lang==='en');
      const d = analyzePayload || {};
      const t = d.technicals || {};
      const a = d.analysts || {};
      const dec = (d.decision || '').toString().toUpperCase();
      const score = typeof d.score === 'number' ? Math.round(d.score) : null;

      const summary = {
        symbol,
        decision_calc: dec,
        score_calc: score,
        technicals: { sma50: t.sma50, sma200: t.sma200, rsi14: t.rsi, macd: t.macd?.macd, signal: t.macd?.signal, hist: t.macd?.hist },
        analysts: { mean: a.mean, trend: a.trend }
      };

      const qPT = `Baseado APENAS nos indicadores t√©cnicos e nos dados dos analistas fornecidos em JSON a seguir,
responda come√ßando pela CONCLUS√ÉO (uma palavra: "COMPRAR", "VENDER" ou "MANTER"), e logo depois explique o racional em 3‚Äì5 frases objetivas.
Evite jarg√µes e n√£o fa√ßa recomenda√ß√£o personalizada. Mantenha tom educacional e conciso.`;

      const qEN = `Based ONLY on the provided technical indicators and analyst data (JSON below),
start with the CONCLUSION (one word: "BUY", "SELL", or "HOLD"), then explain the rationale in 3‚Äì5 concise sentences.
Avoid personalization and keep an educational tone.`;

      const userContent = (isEN ? qEN : qPT) + `\n\nSYMBOL: ${symbol}\nDATA:\n` + JSON.stringify(summary, null, 2);

      const systemContent = isEN
        ? "You are a financial analysis assistant. Provide concise, educational summaries. Do not give personalized advice."
        : "Voc√™ √© um assistente de an√°lise financeira. Forne√ßa resumos concisos e educacionais. N√£o d√™ aconselhamento personalizado.";

      return [
        { role: "system", content: systemContent },
        { role: "user", content: userContent }
      ];
    }

    function renderGrok(text){
      const box = document.getElementById('grokOpinion');
      box.innerHTML = text ? text.replace(/\n/g, '<br/>') : '‚Äî';
    }

    async function askGrok(symbol, analyzePayload){
      const d = dict();
      const titleEl = document.getElementById('grokTitle'); if (titleEl) titleEl.innerHTML = d.grok_title;
      const box = document.getElementById('grokOpinion'); if (box) box.textContent = d.grok_thinking;

      try{
        const messages = buildGrokMessages(symbol, analyzePayload);
        const resp = await fetch(API_BASE + "/kimi?model=" + encodeURIComponent("x-ai/grok-4-fast"), {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ messages })
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const j = await resp.json();
        const content = j?.choices?.[0]?.message?.content || '';
        renderGrok(content || d.grok_error);
      }catch(e){
        console.error('grok error', e);
        renderGrok(dict().grok_error);
      }
    }

    async function runAIAnalysis(symbol){
      const d = dict();
      const aiStatus = document.getElementById('aiStatus');
      aiStatus.textContent = d.refresh+"‚Ä¶";
      try{
        const resp = await fetch(AI_API + "?symbol=" + encodeURIComponent(symbol), { cache:'no-store' });
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const json = await resp.json();

        renderAIResult(json);
        askGrok(symbol, json);

        aiStatus.textContent = d.ai_last_update + (document.documentElement.lang==='en' ? new Date().toLocaleString('en-US',{hour12:false}) : new Date().toLocaleString('pt-BR',{hour12:false}));
      }catch(e){
        console.error('AI analyze error', e);
        aiStatus.textContent = d.could_not_analyze;
      }
    }

    document.getElementById('aiAnalyzeBtn').addEventListener('click', ()=>{
      const s = document.getElementById('aiSymbolInput').value.trim() || getCurrentSymbol();
      if(!s) return; runAIAnalysis(s);
    });
    document.getElementById('aiUseChartBtn').addEventListener('click', ()=>{
      document.getElementById('aiSymbolInput').value = getCurrentSymbol();
    });

    // ===================== Posi√ß√µes: p√∫blico + local =====================
    const posKeyLocal = 'positions_v4_pl_only_autorefresh';
    const cacheKey = 'positions_last_prices_cache_v1';
    const $tbody = document.querySelector('#posTable tbody');
    const $totals = document.getElementById('totals');
    const quoteStatus = document.getElementById('quoteStatus');
    const lastRefreshEl = document.getElementById('lastRefresh');

    let publicPositions = [];
    function readPositionsLocal(){ try{ return JSON.parse(localStorage.getItem(posKeyLocal)) || []; }catch{ return []; } }
    function writePositionsLocal(data){ localStorage.setItem(posKeyLocal, JSON.stringify(data)); }
    function readCache(){ try{ return JSON.parse(localStorage.getItem(cacheKey)) || {}; }catch{ return {}; } }
    function writeCache(obj){ localStorage.setItem(cacheKey, JSON.stringify(obj||{})); }
    function number(v){ return isNaN(parseFloat(v)) ? 0 : parseFloat(v); }
    function fmt(n, d=2){ if(n===null||n===undefined||isNaN(n)) return '-'; return Number(n).toFixed(d); }
    function fmtPct(n){ if(n===null||n===undefined||isNaN(n)) return '-'; return (n>=0?'+':'')+Number(n).toFixed(2)+'%'; }

    function getAllPositions(){
      const locals = readPositionsLocal();
      return [...publicPositions.map(p => ({...p, __public:true})), ...locals.map(p => ({...p, __public:false}))];
    }

    let latestQuotesMap = {};
    function renderPositions(quotesMap={}){
      latestQuotesMap = quotesMap;
      const d = dict();
      const data = getAllPositions();
      $tbody.innerHTML = '';
      data.forEach((row, idx)=>{
        const last = (typeof quotesMap[row.symbol] === 'number') ? quotesMap[row.symbol] : null;
        const pl = (last && row.avg>0) ? ((last/row.avg-1)*100) : null;
        const badge = row.__public ? ` <span class="badge" title="${stripHTML(d.public_badge)}">${d.public_badge}</span>` : '';
        const actions = row.__public
          ? '<span class="status">‚Äî</span>'
          : `<button class="btn" data-act="edit" data-idx="${idx}">${d.edit||'Editar'}</button>
             <button class="btn" data-act="del" data-idx="${idx}">${d.del||'Excluir'}</button>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><button class="btn" data-act="show" data-idx="${idx}" title="${stripHTML(d.open_tv)}">${row.symbol}</button>${badge}</td>
          <td>${fmt(row.avg)}</td>
          <td>${last===null?'-':fmt(last)}</td>
          <td style="font-weight:700; color:${pl===null?'#334155':(pl>=0?'#15803d':'#b91c1c')}">${pl===null?'-':fmtPct(pl)}</td>
          <td>${row.note||''}</td>
          <td class="actions">${actions}</td>`;
        $tbody.appendChild(tr);
      });
      document.querySelectorAll('#posTable thead [data-i18n]').forEach(th=>{
        const key = th.getAttribute('data-i18n'); if(dict()[key]!==undefined) th.textContent = stripHTML(dict()[key]);
      });
      const totalTxt = (d.totals||'Total de posi√ß√µes: {n}').replace('{n}', data.length);
      document.getElementById('totals').textContent = totalTxt;
    }

    async function loadPublicPositions(){
      try{
        const r = await fetch(POS_API, { cache:'no-store' });
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        publicPositions = Array.isArray(j.positions) ? j.positions : [];
      }catch(e){
        console.error('loadPublicPositions', e);
        publicPositions = [];
      }
      await refreshPrices();
    }

    function addPositionLocal(){
      const d = dict();
      const symbol = document.getElementById('posSymbol').value.trim() || getCurrentSymbol();
      const avg = number(document.getElementById('posAvg').value);
      const note = document.getElementById('posNote').value.trim();
      if(!symbol || avg<=0){ alert(d.please_fill); return; }
      const data = readPositionsLocal();
      data.push({symbol, avg, note});
      writePositionsLocal(data);
      document.getElementById('posSymbol').value='';
      document.getElementById('posAvg').value='';
      document.getElementById('posNote').value='';
      refreshPrices();
    }

    async function publishLocalPositions(){
      const d = dict();
      const token = localStorage.getItem('admin_token') || prompt('Admin token (Bearer):');
      if(!token){ return; }
      localStorage.setItem('admin_token', token);
      const list = readPositionsLocal();
      try{
        const r = await fetch(POS_API, {
          method:'POST',
          headers:{ 'content-type':'application/json', 'authorization':'Bearer '+token },
          body: JSON.stringify({ positions: list })
        });
        if(!r.ok){
          const t = await r.text().catch(()=> '');
          throw new Error(`HTTP ${r.status} ${t}`);
        }
        alert((document.documentElement.lang==='en')?'Published!':'Posi√ß√µes publicadas com sucesso!');
        await loadPublicPositions();
      }catch(e){
        console.error('publishLocalPositions', e);
        alert((document.documentElement.lang==='en')?'Failed to publish. Check ADMIN_TOKEN on Worker.':'Falha ao publicar. Verifique o token em ADMIN_TOKEN no Worker.');
      }
    }

    document.getElementById('addPosBtn').addEventListener('click', addPositionLocal);
    document.getElementById('publishBtn').addEventListener('click', publishLocalPositions);
    document.getElementById('loadPublicBtn').addEventListener('click', loadPublicPositions);

    document.getElementById('clearAllBtn').addEventListener('click', ()=>{
      const d = dict();
      if(confirm(d.clear_locals_q)){ writePositionsLocal([]); renderPositions(latestQuotesMap); }
    });
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const rows = readPositionsLocal();
      const header = ['symbol','avg','note'];
      const csv = [header.join(',')].concat(rows.map(r=> `${r.symbol},${r.avg},"${(r.note||'').replace(/"/g,'""')}"`)).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'positions_local.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    document.querySelector('#posTable tbody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const d = dict();
      const act = btn.getAttribute('data-act');
      const idx = parseInt(btn.getAttribute('data-idx'),10);
      const data = getAllPositions();
      const row = data[idx];
      if(act==='del'){
        if(row.__public){ alert((document.documentElement.lang==='en')?'Public position cannot be deleted here.':'Posi√ß√£o p√∫blica n√£o pode ser apagada por aqui.'); return; }
        const locals = readPositionsLocal();
        const found = locals.findIndex(x=> x.symbol===row.symbol && x.avg===row.avg && x.note===row.note);
        if(found>-1){ locals.splice(found,1); writePositionsLocal(locals); refreshPrices(); }
      }else if(act==='edit'){
        if(row.__public){ alert((document.documentElement.lang==='en')?'Public position cannot be edited here.':'Posi√ß√£o p√∫blica n√£o pode ser editada por aqui.'); return; }
        const locals = readPositionsLocal();
        const found = locals.findIndex(x=> x.symbol===row.symbol && x.avg===row.avg && x.note===row.note);
        if(found===-1) return;
        const symbol = prompt((document.documentElement.lang==='en')?'Symbol:':'S√≠mbolo:', row.symbol) || row.symbol;
        const avg = parseFloat(prompt((document.documentElement.lang==='en')?'Avg. price:':'Pre√ßo m√©dio:', row.avg)) || row.avg;
        const note = prompt((document.documentElement.lang==='en')?'Note:':'Observa√ß√£o:', row.note||'') || row.note;
        locals[found] = {symbol, avg, note};
        writePositionsLocal(locals); refreshPrices();
      }else if(act==='show'){
        document.getElementById('chartSymbolInput').value = row.symbol; loadChart(row.symbol);
      }
    });

    // ===================== Pre√ßos via Worker =====================
    async function refreshPrices(){
      const d = dict();
      const rows = getAllPositions();
      const symbols = [...new Set(rows.map(r => (r.symbol||'').trim()).filter(Boolean))];
      if (symbols.length === 0) {
        renderPositions({}); quoteStatus.textContent = d.no_positions;
        lastRefreshEl.textContent = ''; return;
      }
      quoteStatus.textContent = d.upd_prices;
      try{
        const url = QUOTE_API + "?symbols=" + encodeURIComponent(symbols.join(','));
        const resp = await fetch(url, { cache: 'no-store' });
        if(!resp.ok) throw new Error('HTTP ' + resp.status);
        const json = await resp.json();
        const map = json?.prices || {};
        const out = {};
        rows.forEach(r => { const v = map[r.symbol]; out[r.symbol] = (typeof v === 'number') ? v : null; });
        renderPositions(out);
        quoteStatus.textContent = '';
        lastRefreshEl.textContent = d.last_update +
          (document.documentElement.lang==='en'
            ? new Date().toLocaleString('en-US', {hour12:false})
            : new Date().toLocaleString('pt-BR', {hour12:false})
          );
        writeCache(out);
      }catch(e){
        console.error('quotes error', e);
        renderPositions(readCache());
        quoteStatus.textContent = d.no_quotes;
      }
    }

    // ===================== Inicializa√ß√£o =====================
    document.getElementById('y').textContent = new Date().getFullYear();
    loadChart('NASDAQ:NVDA');
    loadPublicPositions();
    document.getElementById('refreshBtn').addEventListener('click', refreshPrices);
    setInterval(refreshPrices, 120000);
  });
  </script>
</body>
</html>
