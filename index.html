<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dicas de AI Investimentos para familia e amigos</title>
  <meta name="description" content="Site com dicas, gr√°fico TradingView, alertas embutidos e minhas posi√ß√µes com P/L %." />
  <link rel="preconnect" href="https://s3.tradingview.com" crossorigin>
  <style>
    :root{ --bg:#f8fafc; --panel:#ffffff; --ink:#0f172a; --muted:#475569; --acc:#0ea5e9; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--ink)}
    a{color:var(--acc);text-decoration:none}
    .wrap{max-width:1150px;margin:0 auto;padding:28px}
    header{display:flex;gap:20px;align-items:center;justify-content:space-between;margin-bottom:22px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:10px;background:conic-gradient(from 210deg,#22d3ee,#6366f1,#22d3ee);box-shadow:0 6px 20px rgba(34,211,238,.25)}
    h1{font-size:clamp(18px,3.2vw,26px);margin:0}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--panel);border:1px solid rgba(0,0,0,.1);border-radius:16px;padding:18px}
    h2{margin:0 0 10px 0;font-size:18px}
    p{color:var(--muted);line-height:1.6;margin:8px 0}
    .tips li{margin:8px 0;color:var(--ink)}
    footer{margin:28px 0 8px 0;text-align:center;color:var(--muted);font-size:12px}
    .btn{cursor:pointer;border-radius:12px;border:1px solid rgba(0,0,0,.15);background:#fff;padding:8px 12px}
    .btn:hover{background:#f1f5f9}
    input,select,textarea{font:inherit;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#fff;color:var(--ink);padding:10px 12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.08);text-align:left}
    th{font-size:13px;color:#334155}
    .status{font-size:12px;color:#475569;margin-top:6px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1 data-i18n="title" id="siteTitle">Dicas AI Investimentos para familia e amigos</h1>
      </div>
      <div>
        <button id="langToggle" class="btn" title="Switch language">üáßüá∑/üá∫üá∏ <span id="langLabel">PT</span></button>
      </div>
    </header>

    <section class="card">
      <h2 data-i18n="quick_tips">Dicas r√°pidas</h2>
      <ul class="tips">
        <li data-i18n="tip1">Defina <strong>entrada, stop e alvo</strong> antes de executar.</li>
        <li data-i18n="tip2">Use <strong>gest√£o de risco</strong> por posi√ß√£o e por carteira.</li>
        <li data-i18n="tip3">Combine <strong>fundamental + t√©cnico</strong> para decis√µes mais s√≥lidas.</li>
      </ul>
    </section>

    <div class="grid" style="margin-top:16px">
      <!-- TradingView -->
      <section class="card" style="grid-column: span 8">
        <h2 data-i18n="chart_title">Gr√°fico (TradingView)</h2>
        <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px;margin:0 0 10px 0">
          <input id="chartSymbolInput" placeholder="Ex.: NASDAQ:NVDA ou BMFBOVESPA:PETR4" style="grid-column:span 6" />
          <button id="setChartBtn" class="btn" style="grid-column:span 2" data-i18n="set_symbol">Carregar s√≠mbolo</button>
          <button id="addFromChartBtn" class="btn" style="grid-column:span 2" data-i18n="add_from_chart">Adicionar √† lista</button>
          <a id="openTV" class="btn" style="grid-column:span 2;text-align:center" href="https://www.tradingview.com/chart/" target="_blank" rel="noopener" data-i18n="open_tv">Abrir no TradingView</a>
        </div>
        <div id="tv-container" style="height:520px">
          <div class="tradingview-widget-container" style="height:100%;width:100%">
            <div id="tradingview_chart" style="height:100%;width:100%"></div>
          </div>
        </div>
        <p class="status" id="tvStatus"></p>
      </section>

      <!-- Alertas (iframe) -->
      <section class="card" style="grid-column: span 4">
        <h2 data-i18n="alerts_title">Alertas (janela interna)</h2>
        <iframe
          src="https://shiny-sea-44d3.rafaelnm.workers.dev/"
          id="alertsFrame"
          title="Alertas ‚Äì Cloudflare Worker"
          loading="lazy"
          referrerpolicy="no-referrer"
          style="width:100%;height:520px;border:1px solid rgba(0,0,0,.1);border-radius:12px;background:#ffffff;color:#000000;">
        </iframe>
        <details style="margin-top:8px"><summary class="status">Se a janela n√£o aparecer</summary>
          <p class="status">No Worker: remova <code>X-Frame-Options</code> e permita <code>frame-ancestors</code> no CSP (inclua seu dom√≠nio do GitHub Pages).</p>
        </details>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h2 data-i18n="ticker_title">Ticker de Cota√ß√µes</h2>
      <div class="tradingview-widget-container">
        <div class="tradingview-widget-container__widget"></div>
        <div class="tradingview-widgetopyright">
          <a href="https://www.tradingview.com/" rel="noopener" target="_blank">TradingView</a>
        </div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
          {
            "symbols": [
              {"proName": "NASDAQ:NVDA", "title": "NVIDIA"},
              {"proName": "NASDAQ:AAPL", "title": "Apple"},
              {"proName": "NASDAQ:AMZN", "title": "Amazon"},
              {"proName": "NASDAQ:ARM", "title": "ARM"},
              {"proName": "NASDAQ:TSLA", "title": "Tesla"},
              {"proName": "BMFBOVESPA:PETR4", "title": "Petrobras PN"},
              {"proName": "BMFBOVESPA:VALE3", "title": "Vale ON"}
            ],
            "showSymbolLogo": true,
            "isTransparent": false,
            "displayMode": "adaptive",
            "colorTheme": "light"
          }
        </script>
      </div>
    </section>

    <!-- Minhas posi√ß√µes -->
    <section class="card" style="margin-top:16px">
      <h2 data-i18n="positions_title">Minhas posi√ß√µes</h2>
      <div class="grid" style="grid-template-columns:repeat(12,1fr);gap:10px;margin:8px 0 12px 0">
        <input id="posSymbol" placeholder="Ex.: NASDAQ:NVDA ou BMFBOVESPA:PETR4" style="grid-column:span 6" />
        <input id="posAvg" type="number" inputmode="decimal" step="0.01" placeholder="Pre√ßo m√©dio" style="grid-column:span 3" />
        <input id="posNote" placeholder="Observa√ß√£o (opcional)" style="grid-column:span 3" />
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="addPosBtn" class="btn" data-i18n="add_position">Adicionar posi√ß√£o</button>
        <button id="refreshBtn" class="btn" data-i18n="refresh">Atualizar pre√ßos</button>
        <button id="clearAllBtn" class="btn" data-i18n="clear_all">Limpar tudo</button>
        <button id="exportBtn" class="btn" data-i18n="export_csv">Exportar CSV</button>
      </div>
      <p class="status" id="quoteStatus"></p>
      <div style="overflow:auto;margin-top:12px">
        <table id="posTable" aria-label="positions">
          <thead>
            <tr>
              <th data-i18n="th_symbol">S√≠mbolo</th>
              <th data-i18n="th_avg">Pre√ßo m√©dio</th>
              <th data-i18n="th_last">Pre√ßo atual</th>
              <th data-i18n="th_pl">P/L %</th>
              <th data-i18n="th_note">Obs.</th>
              <th data-i18n="th_actions">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p id="totals" class="status" style="margin-top:10px"></p>
      <p id="lastRefresh" class="status"></p>
    </section>

    <footer>¬© <span id="y"></span> ‚Ä¢ <span data-i18n="disclaimer">Site educacional, n√£o √© recomenda√ß√£o de investimento.</span></footer>
  </div>

  <!-- TradingView deve ser carregado antes do nosso script principal -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
  // ===================== CONFIG =====================
  const QUOTE_API_BASE = "https://shiny-sea-44d3.rafaelnm.workers.dev/quotes";

  // ===================== I18N =====================
  const I18N = {
    pt:{
      title:"Dicas AI Investimentos para familia e amigos",
      quick_tips:"Dicas r√°pidas",
      tip1:"Defina <strong>entrada, stop e alvo</strong> antes de executar.",
      tip2:"Use <strong>gest√£o de risco</strong> por posi√ß√£o e por carteira.",
      tip3:"Combine <strong>fundamental + t√©cnico</strong> para decis√µes mais s√≥lidas.",
      chart_title:"Gr√°fico (TradingView)",
      alerts_title:"Alertas (janela interna)",
      ticker_title:"Ticker de Cota√ß√µes",
      positions_title:"Minhas posi√ß√µes",
      add_position:"Adicionar posi√ß√£o",
      clear_all:"Limpar tudo",
      export_csv:"Exportar CSV",
      th_symbol:"S√≠mbolo",
      th_avg:"Pre√ßo m√©dio",
      th_last:"Pre√ßo atual",
      th_pl:"P/L %",
      th_note:"Obs.",
      th_actions:"A√ß√µes",
      disclaimer:"Site educacional, n√£o √© recomenda√ß√£o de investimento.",
      edit:"Editar", del:"Excluir",
      totals:"Total de posi√ß√µes: {n}",
      refresh:"Atualizar pre√ßos",
      set_symbol:"Carregar s√≠mbolo",
      add_from_chart:"Adicionar √† lista",
      open_tv:"Abrir no TradingView"
    },
    en:{
      title:"Dicas AI Investimentos para familia e amigos",
      quick_tips:"Quick tips",
      tip1:"Define <strong>entry, stop and target</strong> before executing.",
      tip2:"Use <strong>risk management</strong> per position and portfolio.",
      tip3:"Combine <strong>fundamental + technical</strong> for stronger decisions.",
      chart_title:"Chart (TradingView)",
      alerts_title:"Alerts (embedded window)",
      ticker_title:"Quotes Ticker",
      positions_title:"My positions",
      add_position:"Add position",
      clear_all:"Clear all",
      export_csv:"Export CSV",
      th_symbol:"Symbol",
      th_avg:"Avg. price",
      th_last:"Last price",
      th_pl:"P/L %",
      th_note:"Note",
      th_actions:"Actions",
      disclaimer:"Educational site, not investment advice.",
      edit:"Edit", del:"Delete",
      totals:"Total positions: {n}",
      refresh:"Refresh prices",
      set_symbol:"Load symbol",
      add_from_chart:"Add from chart",
      open_tv:"Open on TradingView"
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    // ===== idioma =====
    function detectLang(){
      const nav = navigator.language || navigator.userLanguage || 'pt-BR';
      return String(nav).toLowerCase().startsWith('en') ? 'en' : 'pt';
    }
    let currentLang = (localStorage.getItem('lang') || detectLang());
    const langLabel = document.getElementById('langLabel');

    function applyI18n(){
      const dict = I18N[currentLang] || I18N.pt;
      document.documentElement.lang = currentLang === 'en' ? 'en' : 'pt-br';
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(dict[key]) el.innerHTML = dict[key];
      });
      langLabel.textContent = currentLang.toUpperCase();
      // recarrega gr√°fico com locale
      loadChart(getCurrentSymbol(), currentLang === 'en' ? 'en' : 'br');
      renderPositions();
    }

    document.getElementById('langToggle').addEventListener('click', ()=>{
      currentLang = currentLang === 'en' ? 'pt' : 'en';
      localStorage.setItem('lang', currentLang);
      applyI18n();
    });

    // ===================== TradingView =====================
    const DEFAULT_SYMBOL = 'NASDAQ:AAPL';
    let tvWidgetInstance;

    function getCurrentSymbol(){ return window.__CURRENT_SYMBOL || DEFAULT_SYMBOL; }
    function setCurrentSymbol(s){ window.__CURRENT_SYMBOL = s; }

    function loadChart(symbol, locale){
      const tvStatus = document.getElementById('tvStatus');
      try{
        const loc = locale || (currentLang === 'en' ? 'en' : 'br');
        const s = (symbol || DEFAULT_SYMBOL).trim();
        setCurrentSymbol(s);
        if(tvWidgetInstance && typeof tvWidgetInstance.remove === 'function'){
          tvWidgetInstance.remove();
        }
        tvWidgetInstance = new TradingView.widget({
          autosize: true,
          symbol: s,
          interval: "60",
          timezone: "Etc/UTC",
          theme: "light",
          style: "1",
          locale: loc,
          enable_publishing: false,
          container_id: "tradingview_chart",
          withdateranges: true,
          allow_symbol_change: true
        });
        document.getElementById('openTV').href = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(s)}`;
        const input = document.getElementById('chartSymbolInput');
        if(input && !input.value) input.value = s;
        tvStatus.textContent = '';
      }catch(e){
        tvStatus.textContent = (currentLang==='en'?'Could not load chart now.':'N√£o foi poss√≠vel carregar o gr√°fico agora.');
        console.error('TradingView error', e);
      }
    }

    // Controles de s√≠mbolo
    document.getElementById('setChartBtn').addEventListener('click', ()=>{
      const s = document.getElementById('chartSymbolInput').value.trim();
      if(!s){ alert(currentLang==='en'?'Enter a symbol':'Informe um s√≠mbolo'); return; }
      loadChart(s);
    });
    document.getElementById('addFromChartBtn').addEventListener('click', ()=>{
      document.getElementById('posSymbol').value = getCurrentSymbol();
      document.getElementById('posAvg').focus();
    });

    // ===================== Posi√ß√µes =====================
    const posKey = 'positions_v4_pl_only_autorefresh';
    const cacheKey = 'positions_last_prices_cache_v1';
    const $tbody = document.querySelector('#posTable tbody');
    const $totals = document.getElementById('totals');
    const quoteStatus = document.getElementById('quoteStatus');
    const lastRefreshEl = document.getElementById('lastRefresh');

    function readPositions(){
      try{ return JSON.parse(localStorage.getItem(posKey)) || []; }catch(e){ return []; }
    }
    function writePositions(data){ localStorage.setItem(posKey, JSON.stringify(data)); }
    function readCache(){ try{ return JSON.parse(localStorage.getItem(cacheKey)) || {}; }catch(e){ return {}; } }
    function writeCache(obj){ localStorage.setItem(cacheKey, JSON.stringify(obj||{})); }

    function number(v){ return isNaN(parseFloat(v)) ? 0 : parseFloat(v); }
    function fmt(n, digits=2){ if(n===null||n===undefined||isNaN(n)) return '-'; return Number(n).toFixed(digits); }
    function fmtPct(n){ if(n===null||n===undefined||isNaN(n)) return '-'; return (n>=0?'+':'')+Number(n).toFixed(2)+'%'; }

    function renderPositions(quotesMap={}){
      const dict = I18N[currentLang] || I18N.pt;
      const data = readPositions();
      $tbody.innerHTML = '';
      data.forEach((row, idx)=>{
        const last = (typeof quotesMap[row.symbol] === 'number') ? quotesMap[row.symbol] : null;
        const pl = (last && row.avg>0) ? ((last/row.avg-1)*100) : null;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><button class="btn" data-act="show" data-idx="${idx}" title="Mostrar no gr√°fico">${row.symbol}</button></td>
          <td>${fmt(row.avg)}</td>
          <td>${last===null?'-':fmt(last)}</td>
          <td style="font-weight:700; color:${pl===null?'#334155':(pl>=0?'#15803d':'#b91c1c')}">${pl===null?'-':fmtPct(pl)}</td>
          <td>${row.note||''}</td>
          <td class="actions">
            <button class="btn" data-act="edit" data-idx="${idx}">${dict.edit}</button>
            <button class="btn" data-act="del" data-idx="${idx}">${dict.del}</button>
          </td>`;
        $tbody.appendChild(tr);
      });
      $totals.textContent = (dict.totals||'').replace('{n}', data.length);
    }

    function addPosition(){
      const symbol = document.getElementById('posSymbol').value.trim() || getCurrentSymbol();
      const avg = number(document.getElementById('posAvg').value);
      const note = document.getElementById('posNote').value.trim();
      if(!symbol || avg<=0){
        alert(currentLang==='en' ? 'Please fill symbol and avg. price.' : 'Preencha s√≠mbolo e pre√ßo m√©dio.');
        return;
      }
      const data = readPositions();
      data.push({symbol, avg, note});
      writePositions(data);
      document.getElementById('posSymbol').value='';
      document.getElementById('posAvg').value='';
      document.getElementById('posNote').value='';
      refreshPrices();
    }

    document.getElementById('addPosBtn').addEventListener('click', addPosition);
    document.getElementById('clearAllBtn').addEventListener('click', ()=>{
      if(confirm(currentLang==='en' ? 'Clear all positions?' : 'Limpar todas as posi√ß√µes?')){
        writePositions([]); renderPositions({}); quoteStatus.textContent=''; lastRefreshEl.textContent='';
      }
    });
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const rows = readPositions();
      const header = ['symbol','avg','note'];
      const csv = [header.join(',')].concat(rows.map(r=> `${r.symbol},${r.avg},"${(r.note||'').replace(/"/g,'""')}"`)).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'positions.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    document.querySelector('#posTable tbody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const act = btn.getAttribute('data-act');
      const idx = parseInt(btn.getAttribute('data-idx'),10);
      const data = readPositions();
      if(act==='del'){
        data.splice(idx,1); writePositions(data); refreshPrices();
      }else if(act==='edit'){
        const row = data[idx];
        const symbol = prompt(currentLang==='en'?'Symbol:':'S√≠mbolo:', row.symbol) || row.symbol;
        const avg = parseFloat(prompt(currentLang==='en'?'Avg. price:':'Pre√ßo m√©dio:', row.avg)) || row.avg;
        const note = prompt(currentLang==='en'?'Note:':'Observa√ß√£o:', row.note||'') || row.note;
        data[idx] = {symbol, avg, note};
        writePositions(data); refreshPrices();
      }else if(act==='show'){
        const row = data[idx];
        document.getElementById('chartSymbolInput').value = row.symbol;
        loadChart(row.symbol);
      }
    });

    // ===================== Pre√ßos via seu Worker =====================
    async function refreshPrices(){
      const rows = readPositions();
      const symbols = [...new Set(rows.map(r => (r.symbol||'').trim()).filter(Boolean))];

      if (symbols.length === 0) {
        renderPositions({});
        const msg = (document.documentElement.lang === 'en' ? 'Add a position to fetch prices.' : 'Adicione uma posi√ß√£o para buscar pre√ßos.');
        quoteStatus.textContent = msg;
        lastRefreshEl.textContent = '';
        return;
      }

      quoteStatus.textContent = (document.documentElement.lang === 'en' ? 'Updating prices‚Ä¶' : 'Atualizando pre√ßos‚Ä¶');

      try{
        const url = QUOTE_API_BASE + "?symbols=" + encodeURIComponent(symbols.join(','));
        const resp = await fetch(url, { cache: 'no-store' });
        if(!resp.ok) throw new Error('HTTP ' + resp.status);
        const json = await resp.json();
        const map = json?.prices || {};

        // monta mapa apenas do que est√° listado
        const out = {};
        rows.forEach(r => {
          const v = map[r.symbol];
          out[r.symbol] = (typeof v === 'number') ? v : null;
        });

        renderPositions(out);
        quoteStatus.textContent = '';
        const isEN = document.documentElement.lang === 'en';
        lastRefreshEl.textContent = (isEN ? 'Last update: ' : '√öltima atualiza√ß√£o: ') +
          new Date().toLocaleString(isEN?'en-US':'pt-BR', {hour12:false});
        writeCache(out);
      }catch(e){
        console.error('quotes error', e);
        const cache = readCache();
        renderPositions(cache);
        quoteStatus.textContent = (document.documentElement.lang === 'en' ? 'Could not update quotes.' : 'N√£o foi poss√≠vel atualizar as cota√ß√µes.');
      }
    }

    // ===================== Inicializa√ß√£o =====================
    document.getElementById('y').textContent = new Date().getFullYear();
    applyI18n();
    loadChart(DEFAULT_SYMBOL);
    refreshPrices();

    // Bot√£o Atualizar
    document.getElementById('refreshBtn').addEventListener('click', refreshPrices);

    // Auto refresh
    const AUTO_REFRESH_MS = 120000; // 2 min
    setInterval(refreshPrices, AUTO_REFRESH_MS);
  });
  </script>
</body>
</html>
