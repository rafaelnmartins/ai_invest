<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Investimentos - Dicas para familia e amigos</title>
  <meta name="description" content="Site com dicas, gr√°fico TradingView, alertas embutidos e minhas posi√ß√µes com P/L %." />
  <link rel="preconnect" href="https://s3.tradingview.com" crossorigin>
  <!-- Optional: subtle system UI + better readability -->
  <style>
    /* =========================
       Theme variables
       ========================= */
    :root{
      --page-bg: #f3f4f6;        /* light gray page background (not black) */
      --panel: #ffffff;          /* cards */
      --muted: #64748b;          /* muted text */
      --ink: #0f172a;            /* primary text */
      --accent: #0ea5e9;         /* accent / links */
      --accent-2: #6366f1;       /* secondary accent */
      --success: #15803d;
      --danger: #b91c1c;
      --glass: rgba(255,255,255,0.6);
      --radius: 14px;
      --card-border: rgba(15,23,42,0.04);
      --shadow-1: 0 6px 18px rgba(15,23,42,0.06);
      --compact-gap: 12px;
      --max-width: 1150px;
    }

    /* =========================
       Base reset & layout
       ========================= */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--page-bg), #eef2f6 60%);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.5;
      -webkit-tap-highlight-color: transparent;
    }
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:var(--max-width);margin:22px auto;padding:20px}
    header{display:flex;gap:20px;align-items:center;justify-content:space-between;margin-bottom:20px}
    .brand{display:flex;gap:14px;align-items:center}
    .logo{
      width:52px;height:52px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      box-shadow: 0 8px 30px rgba(99,102,241,0.14);
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
      font-family:monospace;font-size:18px;
    }
    h1{font-size:clamp(18px,2.6vw,26px);margin:0;letter-spacing:-0.2px}
    header .meta{color:var(--muted);font-size:13px}

    /* =========================
       Grid system
       ========================= */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }

    /* =========================
       Card component
       ========================= */
    .card{
      background:var(--panel);
      border:1px solid var(--card-border);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow-1);
    }
    .card.header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 18px;
    }
    .card h2{margin:0 0 8px 0;font-size:18px}
    .card h3{margin:0 0 6px 0;font-size:14px;color:var(--muted)}
    p{color:var(--muted);margin:8px 0}
    .muted{color:var(--muted);font-size:13px}

    /* =========================
       Controls & inputs
       ========================= */
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      cursor:pointer;border-radius:12px;border:1px solid rgba(15,23,42,0.06);
      background:linear-gradient(180deg,#fff,#f7fbff);
      padding:8px 12px;font-weight:600;font-size:13px;color:var(--ink);
      box-shadow: 0 2px 6px rgba(2,6,23,0.04);
    }
    .btn.ghost{background:transparent;border:1px dashed rgba(15,23,42,0.06)}
    .btn.small{padding:6px 10px;font-size:13px;border-radius:10px}
    .btn:active{transform:translateY(1px)}
    input,select,textarea{font:inherit;border-radius:12px;border:1px solid rgba(2,6,23,0.06);background:#fff;color:var(--ink);padding:10px 12px;min-height:40px}
    input::placeholder{color:#94a3b8}

    /* compact grid helper inside cards */
    .form-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:center}
    .col-span-6{grid-column:span 6}
    .col-span-4{grid-column:span 4}
    .col-span-3{grid-column:span 3}
    .col-span-2{grid-column:span 2}
    .col-span-12{grid-column:span 12}

    /* =========================
       Alerts iframe styling
       ========================= */
    iframe{
      width:100%;height:520px;border:0;border-radius:10px;box-shadow:0 8px 20px rgba(2,6,23,0.04);
      background:transparent;
    }

    /* =========================
       Table styling
       ========================= */
    .table-wrap{overflow:auto;border-radius:10px;border:1px solid rgba(2,6,23,0.03)}
    table{width:100%;border-collapse:collapse;min-width:680px}
    th,td{padding:12px 14px;text-align:left;border-bottom:1px solid rgba(2,6,23,0.04)}
    th{font-size:13px;color:#334155;font-weight:600;background:linear-gradient(180deg,rgba(255,255,255,0.4),rgba(250,250,250,0.4))}
    tbody tr:hover{background:linear-gradient(90deg, rgba(14,165,233,0.02), transparent)}
    .actions .btn{margin-right:6px}

    /* =========================
       Badges & status
       ========================= */
    .badge{
      display:inline-flex;align-items:center;gap:8px;font-size:13px;color:#0369a1;background:#e0f2fe;border:1px solid #bae6fd;border-radius:999px;padding:6px 10px;
      font-weight:600;
    }
    .status{font-size:13px;color:var(--muted);margin-top:6px}

    /* =========================
       Tips list
       ========================= */
    .tips{padding-left:18px;margin:10px 0}
    .tips li{margin:8px 0;color:var(--ink)}

    /* =========================
       TV Chart container improvements
       ========================= */
    #tradingview_chart{
      height:520px;width:100%;border-radius:10px;overflow:hidden;border:1px solid rgba(2,6,23,0.03);
      background:linear-gradient(180deg,#ffffff,#fbfdff);
      display:flex;align-items:center;justify-content:center;position:relative;
    }
    /* small overlay to show symbol/title */
    .chart-topbar{
      position:absolute;left:12px;top:12px;padding:6px 10px;border-radius:999px;font-size:13px;background:rgba(255,255,255,0.6);backdrop-filter:blur(4px);border:1px solid rgba(2,6,23,0.04)
    }

    /* =========================
       Footer
       ========================= */
    footer{margin:28px 0 8px 0;text-align:center;color:var(--muted);font-size:13px}

    /* =========================
       Responsive tweaks
       ========================= */
    @media (max-width:720px){
      .logo{width:44px;height:44px;font-size:16px}
      #tradingview_chart{height:360px}
      iframe{height:360px}
    }

    /* =========================
       Utility helpers
       ========================= */
    .muted-small{color:var(--muted);font-size:12px}
    .text-green{color:var(--success);font-weight:700}
    .text-red{color:var(--danger);font-weight:700}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">AI</div>
        <div>
          <h1 data-i18n="title" id="siteTitle">Dicas AI Investimentos para familia e amigos</h1>
          <div class="meta muted-small">Gr√°ficos TradingView ‚Ä¢ Alertas em tempo real ‚Ä¢ Posic√µes p√∫blicas e locais</div>
        </div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <div class="muted-small">Tema: Claro ‚Äî Fundo cinza</div>
        <button id="langToggle" class="btn small" title="Switch language">üáßüá∑/üá∫üá∏ <span id="langLabel">PT</span></button>
      </div>
    </header>

    <!-- 1) Dicas r√°pidas -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
        <div>
          <h2 data-i18n="quick_tips">Dicas r√°pidas</h2>
          <p class="muted">Resumo pr√°tico para uso di√°rio dos sinais gerados pelo agente.</p>
        </div>
        <div class="muted-small">√öltima leitura: <strong id="lastRefreshTop">‚Äî</strong></div>
      </div>

      <ul class="tips" style="margin-top:8px">
        <li>Todos os dias o <strong>Agente</strong> enviar√° os alertas <strong>ap√≥s o fechamento</strong> da bolsa de Wall Street.</li>
        <li>Alertas de <strong>compra (curto prazo)</strong> buscam ganho de <strong>5%</strong>; de <strong>longo prazo</strong> buscam <strong>10%</strong>.</li>
        <li>Fique ligado aos <strong>alertas de venda</strong> e sempre defina <strong>stop</strong>.</li>
      </ul>
    </section>

    <!-- 2) Opini√£o da AI (com Grok) ao lado dos Alertas -->
    <div class="grid" style="margin-top:16px">
      <!-- Opini√£o da AI -->
      <section class="card" id="ai-opinion" style="grid-column: span 8">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div>
            <h2 id="aiTitle">Opini√£o da AI (T√©cnico + Analistas)</h2>
            <div class="muted-small" id="aiSubtitle">Resultado do worker /analyze + opini√£o extra via Grok</div>
          </div>
          <div class="controls">
            <div style="display:flex;gap:8px;align-items:center">
              <input id="aiSymbolInput" placeholder="Ex.: NASDAQ:AMZN ou AMZN" style="min-width:220px" />
              <button id="aiAnalyzeBtn" class="btn small">Analisar</button>
              <button id="aiUseChartBtn" class="btn small ghost">Usar do gr√°fico</button>
            </div>
          </div>
        </div>

        <!-- Resultado calculado pelo Worker (/analyze) -->
        <div id="aiResult" class="card" style="background:linear-gradient(180deg,#fbfdff,#ffffff);border:1px dashed rgba(2,6,23,0.03);min-height:90px;margin-top:12px"></div>

        <!-- Opini√£o extra via LLM (Grok / OpenRouter) -->
        <div id="grokBox" class="card" style="margin-top:12px;background:#fff7ed;border:1px solid #fde3bf">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <h3 id="grokTitle" style="margin:0">Opini√£o extra da IA (Grok)</h3>
            <div class="muted-small">Resumo conciso gerado pela LLM</div>
          </div>
          <div id="grokOpinion" class="status" style="margin-top:10px">‚Äî</div>
        </div>

        <p class="status" id="aiStatus" style="margin-top:10px"></p>
      </section>

      <!-- Alertas -->
      <section class="card" style="grid-column: span 4">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div>
            <h2 data-i18n="alerts_title">Alertas</h2>
            <div class="muted-small">Janela com alertas do seu Worker (Cloudflare)</div>
          </div>
          <span class="badge">‚ö° Agent</span>
        </div>

        <div style="margin-top:10px;border-radius:10px;overflow:hidden">
          <iframe
            src="https://shiny-sea-44d3.rafaelnm.workers.dev/"
            id="alertsFrame"
            title="Alertas ‚Äì Cloudflare Worker"
            loading="lazy"
            referrerpolicy="no-referrer"
            style="background:#fff;color:#000;">
          </iframe>
        </div>

        <details style="margin-top:10px"><summary class="muted-small">Se a janela n√£o aparecer</summary>
          <p class="muted-small">No Worker: remova <code>X-Frame-Options</code> e permita <code>frame-ancestors</code> no CSP (inclua seu dom√≠nio do GitHub Pages).</p>
        </details>
      </section>
    </div>

    <!-- 3) Minhas posi√ß√µes -->
    <section class="card" style="margin-top:16px">
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap">
        <div>
          <h2 data-i18n="positions_title">Minhas posi√ß√µes</h2>
          <div class="muted-small">Combine posi√ß√µes p√∫blicas e locais; P/L calculado com √∫ltimas cota√ß√µes.</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <span class="badge" title="Visitantes veem essas posi√ß√µes">üåê P√∫blico</span>
          <button id="loadPublicBtn" class="btn small">Atualizar p√∫blicas</button>
          <button id="publishBtn" class="btn small" title="Enviar posi√ß√µes locais para o servidor (admin)">Publicar (admin)</button>
        </div>
      </div>

      <div class="form-grid" style="margin-top:12px">
        <input id="posSymbol" class="col-span-6" placeholder="Ex.: NASDAQ:NVDA ou BMFBOVESPA:PETR4" />
        <input id="posAvg" class="col-span-3" type="number" inputmode="decimal" step="0.01" placeholder="Pre√ßo m√©dio" />
        <input id="posNote" class="col-span-3" placeholder="Observa√ß√£o (opcional)" />
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button id="addPosBtn" class="btn">Adicionar posi√ß√£o (local)</button>
        <button id="refreshBtn" class="btn">Atualizar pre√ßos</button>
        <button id="clearAllBtn" class="btn ghost">Limpar locais</button>
        <button id="exportBtn" class="btn ghost">Exportar CSV (locais)</button>
      </div>

      <p class="status" id="quoteStatus"></p>

      <div class="table-wrap" style="margin-top:12px">
        <table id="posTable" aria-label="positions">
          <thead>
            <tr>
              <th data-i18n="th_symbol">S√≠mbolo</th>
              <th data-i18n="th_avg">Pre√ßo m√©dio</th>
              <th data-i18n="th_last">Pre√ßo atual</th>
              <th data-i18n="th_pl">P/L %</th>
              <th data-i18n="th_note">Obs.</th>
              <th data-i18n="th_actions">A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;flex-wrap:wrap;gap:8px">
        <p id="totals" class="status"></p>
        <p id="lastRefresh" class="muted-small"></p>
      </div>
    </section>

    <!-- 4) Gr√°fico (TradingView) + novo quadro de dicas -->
    <div class="grid" style="margin-top:16px;align-items:start">
      <!-- Gr√°fico -->
      <section class="card" style="grid-column: span 8">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <div>
            <h2 data-i18n="chart_title">Gr√°fico (TradingView)</h2>
            <div class="muted-small">Carregue o s√≠mbolo e use os controles para adicionar √† sua lista.</div>
          </div>

          <div class="controls">
            <input id="chartSymbolInput" placeholder="Ex.: NASDAQ:NVDA ou BMFBOVESPA:PETR4" style="min-width:240px" />
            <button id="setChartBtn" class="btn small" data-i18n="set_symbol">Carregar s√≠mbolo</button>
            <button id="addFromChartBtn" class="btn small ghost" data-i18n="add_from_chart">Adicionar √† lista</button>
            <a id="openTV" class="btn small" style="text-align:center" href="https://www.tradingview.com/chart/" target="_blank" rel="noopener" data-i18n="open_tv">Abrir no TradingView</a>
          </div>
        </div>

        <div id="tradingview_chart" class="card" style="margin-top:12px;padding:0">
          <div class="chart-topbar" id="chartTopbar">S√≠mbolo: <strong id="chartSymbolLabel">‚Äî</strong></div>
          <!-- TradingView widget injected into this div by tv.js -->
        </div>
        <p class="status" id="tvStatus" style="margin-top:10px"></p>
      </section>

      <!-- Novo quadro de dicas ao lado do gr√°fico -->
      <section class="card" style="grid-column: span 4">
        <h2>Boas pr√°ticas no gr√°fico</h2>
        <ul class="tips">
          <li>Evite decis√µes com base em <strong>1 indicador</strong> apenas. Confirme com 2‚Äì3 sinais.</li>
          <li>Observe a <strong>tend√™ncia (SMA50 x SMA200)</strong> antes do gatilho.</li>
          <li>Prefira entrar com <strong>parcial</strong> e completar se o movimento confirmar.</li>
          <li>Defina um <strong>stop t√©cnico</strong> e um <strong>alvo</strong> antes de clicar.</li>
          <li>Revise not√≠cias/earnings que possam afetar o papel.</li>
        </ul>

        <div style="margin-top:12px">
          <h3 style="margin-bottom:8px">Checklist r√°pido</h3>
          <ul class="tips">
            <li>Volume confirmando o movimento?</li>
            <li>Pre√ßo acima da m√©dia relevante?</li>
            <li>Risco/recompensa favor√°vel &lt; 1:2?</li>
          </ul>
        </div>
      </section>
    </div>

    <!-- Ticker global no final da p√°gina -->
    <section class="card" style="margin-top:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <h2>Mercados Globais &amp; Magnificent 7</h2>
        <div class="muted-small">Acompanhe os √≠ndices e mega-cap tech</div>
      </div>

      <div class="tradingview-widget-container" style="margin-top:12px">
        <div class="tradingview-widget-container__widget"></div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js" async>
          {
            "symbols": [
              {"proName": "FOREXCOM:US30",  "title": "Dow Jones"},
              {"proName": "FOREXCOM:US100", "title": "Nasdaq 100"},
              {"proName": "FOREXCOM:US500", "title": "S&P 500"},
              {"proName": "BMFBOVESPA:IBOV", "title": "Ibovespa"},
              {"proName": "FOREXCOM:EU50",  "title": "Euro Stoxx 50"},
              {"proName": "FOREXCOM:UK100", "title": "FTSE 100"},

              {"proName": "NASDAQ:AAPL",  "title": "Apple"},
              {"proName": "NASDAQ:MSFT",  "title": "Microsoft"},
              {"proName": "NASDAQ:GOOGL", "title": "Alphabet"},
              {"proName": "NASDAQ:AMZN",  "title": "Amazon"},
              {"proName": "NASDAQ:NVDA",  "title": "NVIDIA"},
              {"proName": "NASDAQ:META",  "title": "Meta"},
              {"proName": "NASDAQ:TSLA",  "title": "Tesla"}
            ],
            "showSymbolLogo": true,
            "isTransparent": false,
            "displayMode": "adaptive",
            "colorTheme": "light"
          }
        </script>
      </div>
    </section>

    <footer>¬© <span id="y"></span> ‚Ä¢ <span data-i18n="disclaimer">Site educacional, n√£o √© recomenda√ß√£o de investimento.</span></footer>
  </div>

  <!-- Keep original TradingView library and the script intact; we only improved layout/CSS above -->
  <script src="https://s3.tradingview.com/tv.js"></script>
  <script>
  // ===================== CONFIG =====================
  const API_BASE = "https://shiny-sea-44d3.rafaelnm.workers.dev";
  const QUOTE_API = API_BASE + "/quotes";
  const POS_API   = API_BASE + "/positions";
  const AI_API    = API_BASE + "/analyze"; // Worker: /analyze
  // LLM (Grok via OpenRouter) est√° exposto no seu Worker como /kimi

  // ===================== I18N =====================
  const I18N = {
    pt:{ title:"AI Invest - Dicas de A√ß√µes para familia e amigos", quick_tips:"Dicas r√°pidas",
      tip1:"Defina <strong>entrada, stop e alvo</strong> antes de executar.",
      tip2:"Use <strong>gest√£o de risco</strong> por posi√ß√£o e por carteira.",
      tip3:"Combine <strong>fundamental + t√©cnico</strong> para decis√µes mais s√≥lidas.",
      chart_title:"Gr√°fico (TradingView)", alerts_title:"Alertas",
      ticker_title:"Ticker de Cota√ß√µes", positions_title:"Minhas posi√ß√µes",
      add_position:"Adicionar posi√ß√£o", clear_all:"Limpar tudo", export_csv:"Exportar CSV",
      th_symbol:"S√≠mbolo", th_avg:"Pre√ßo m√©dio", th_last:"Pre√ßo atual", th_pl:"P/L %",
      th_note:"Obs.", th_actions:"A√ß√µes", disclaimer:"Site educacional, n√£o √© recomenda√ß√£o de investimento - rafaelnm@gmail.com",
      edit:"Editar", del:"Excluir", totals:"Total de posi√ß√µes: {n}", refresh:"Atualizar pre√ßos",
      set_symbol:"Carregar s√≠mbolo", add_from_chart:"Adicionar √† lista", open_tv:"Abrir no TradingView",
      ai_title:"Opini√£o da AI (T√©cnico + Analistas)", ai_analyze:"Analisar", ai_use_chart:"Usar s√≠mbolo do gr√°fico",
      ai_decision:"Decis√£o", ai_score:"Score", ai_reasons:"Motivos", ai_technicals:"T√©cnicos", ai_analysts:"Analistas",
      ai_buy:"Comprar", ai_hold:"Manter", ai_sell:"Vender", ai_last_update:"√öltima an√°lise"
    },
    en:{ title:"AI Invest - Stocks TIPs for Family and Friends", quick_tips:"Quick tips",
      tip1:"Define <strong>entry, stop and target</strong> before executing.",
      tip2:"Use <strong>risk management</strong> per position and portfolio.",
      tip3:"Combine <strong>fundamental + technical</strong> for stronger decisions.",
      chart_title:"Chart (TradingView)", alerts_title:"Alerts",
      ticker_title:"Quotes Ticker", positions_title:"My positions", add_position:"Add position",
      clear_all:"Clear all", export_csv:"Export CSV", th_symbol:"Symbol", th_avg:"Avg. price",
      th_last:"Last price", th_pl:"P/L %", th_note:"Note", th_actions:"Actions",
      disclaimer:"Educational site, not investment advice - rafaelnm@gmail.com", edit:"Edit", del:"Delete",
      totals:"Total positions: {n}", refresh:"Refresh prices", set_symbol:"Load symbol",
      add_from_chart:"Add from chart", open_tv:"Open on TradingView",
      ai_title:"AI Opinion (Technical + Analysts)", ai_analyze:"Analyze", ai_use_chart:"Use chart symbol",
      ai_decision:"Decision", ai_score:"Score", ai_reasons:"Reasons", ai_technicals:"Technicals", ai_analysts:"Analysts",
      ai_buy:"Buy", ai_hold:"Hold", ai_sell:"Sell", ai_last_update:"Last analysis"
    }
  };

  document.addEventListener('DOMContentLoaded', () => {
    // ===== idioma =====
    function detectLang(){ const nav = navigator.language || 'pt-BR'; return String(nav).toLowerCase().startsWith('en') ? 'en' : 'pt'; }
    let currentLang = (localStorage.getItem('lang') || detectLang());
    const langLabel = document.getElementById('langLabel');
    function applyI18n(){
      const dict = I18N[currentLang] || I18N.pt;
      document.documentElement.lang = currentLang === 'en' ? 'en' : 'pt-br';
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(dict[key]) el.innerHTML = dict[key];
      });
      langLabel.textContent = currentLang.toUpperCase();
      loadChart(getCurrentSymbol(), currentLang === 'en' ? 'en' : 'br');
      renderPositions(latestQuotesMap);

      // Ajuste do t√≠tulo do Grok
      const gdict = grokDict();
      const gt = document.getElementById('grokTitle'); if (gt) gt.textContent = gdict.title;
    }
    document.getElementById('langToggle').addEventListener('click', ()=>{
      currentLang = currentLang === 'en' ? 'pt' : 'en'; localStorage.setItem('lang', currentLang); applyI18n();
    });

    // ===================== TradingView =====================
    const DEFAULT_SYMBOL = 'NASDAQ:NVDA';
    let tvWidgetInstance;
    function getCurrentSymbol(){ return window.__CURRENT_SYMBOL || DEFAULT_SYMBOL; }
    function setCurrentSymbol(s){ window.__CURRENT_SYMBOL = s; }
    function loadChart(symbol, locale){
      const tvStatus = document.getElementById('tvStatus');
      try{
        const loc = locale || (currentLang === 'en' ? 'en' : 'br');
        const s = (symbol || DEFAULT_SYMBOL).trim();
        setCurrentSymbol(s);
        // update chart label (UI improvement)
        const chartLabel = document.getElementById('chartSymbolLabel');
        if (chartLabel) chartLabel.textContent = s;

        if(tvWidgetInstance && typeof tvWidgetInstance.remove === 'function'){ tvWidgetInstance.remove(); }
        tvWidgetInstance = new TradingView.widget({
          autosize:true, symbol:s, interval:"60", timezone:"Etc/UTC", theme:"light", style:"1", locale:loc,
          enable_publishing:false, container_id:"tradingview_chart", withdateranges:true, allow_symbol_change:true
        });
        document.getElementById('openTV').href = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent(s)}`;
        const input = document.getElementById('chartSymbolInput'); if(input && !input.value) input.value = s;
        tvStatus.textContent = '';
      }catch(e){ tvStatus.textContent = (currentLang==='en'?'Could not load chart now.':'N√£o foi poss√≠vel carregar o gr√°fico agora.'); console.error(e); }
    }
    document.getElementById('setChartBtn').addEventListener('click', ()=>{
      const s = document.getElementById('chartSymbolInput').value.trim(); if(!s){ alert(currentLang==='en'?'Enter a symbol':'Informe um s√≠mbolo'); return; } loadChart(s);
    });
    document.getElementById('addFromChartBtn').addEventListener('click', ()=>{
      document.getElementById('posSymbol').value = getCurrentSymbol(); document.getElementById('posAvg').focus();
    });

    // ===================== Opini√£o da AI (Worker /analyze + Grok via /kimi) =====================
    function aiDict(){ return (document.documentElement.lang==='en') ? I18N.en : I18N.pt; }

    function renderAIResult(payload){
      const d = aiDict();
      const box = document.getElementById('aiResult');
      if(!payload || typeof payload !== 'object'){ box.innerHTML = '<p class="status">'+(d.ai_last_update+': ‚Äî')+'</p>'; return; }
      const dec = String(payload.decision||'').toUpperCase();
      const mapLabel = { BUY:d.ai_buy, HOLD:d.ai_hold, SELL:d.ai_sell };
      const color = dec==='BUY' ? '#15803d' : (dec==='SELL' ? '#b91c1c' : '#334155');
      const score = (typeof payload.score==='number') ? Math.round(payload.score) : null;
      const tech = payload.technicals||{}; const an = payload.analysts||{}; const reasons = payload.reasons||[];
      box.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <span class="badge" style="background:#f1f5f9;border-color:#e2e8f0;color:${color}"><strong>${d.ai_decision}:</strong> ${mapLabel[dec]||dec}</span>
          ${score!==null?`<span class="badge"><strong>${d.ai_score}:</strong> ${score}/100</span>`:''}
        </div>
        <div style="display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:10px">
          <div class="card" style="grid-column:span 6">
            <h3 style="margin:0 0 6px 0">${d.ai_technicals}</h3>
            <ul style="margin:0;padding-left:18px">
              <li>SMA50: <strong>${tech.sma50??'-'}</strong> ¬∑ SMA200: <strong>${tech.sma200??'-'}</strong></li>
              <li>RSI14: <strong>${tech.rsi??'-'}</strong></li>
              <li>MACD: <strong>${tech.macd?.macd??'-'}</strong> ¬∑ Signal: <strong>${tech.macd?.signal??'-'}</strong></li>
            </ul>
          </div>
          <div class="card" style="grid-column:span 6">
            <h3 style="margin:0 0 6px 0">${d.ai_analysts}</h3>
            <ul style="margin:0;padding-left:18px">
              <li>Mean: <strong>${an.mean??'-'}</strong></li>
              <li>Trend: ${an.trend ? `<strong>buy ${an.trend.buy||0}</strong> ¬∑ hold ${an.trend.hold||0} ¬∑ sell ${an.trend.sell||0}` : '-'}</li>
            </ul>
          </div>
        </div>
        ${reasons.length?`<div style="margin-top:8px"><strong>${d.ai_reasons}:</strong><ul style="margin:6px 0;padding-left:18px">${reasons.map(r=>`<li>${r}</li>`).join('')}</ul></div>`:''}
      `;
    }

    // ======== R√≥tulos para Grok ========
    function grokDict(){
      const isEN = document.documentElement.lang === 'en';
      return isEN ? {
        thinking: "Asking Grok‚Ä¶",
        title: "Extra AI Opinion (Grok)",
        introDecision: "Conclusion",
        error: "Could not get Grok opinion now."
      } : {
        thinking: "Consultando o Grok‚Ä¶",
        title: "Opini√£o extra da IA (Grok)",
        introDecision: "Conclus√£o",
        error: "N√£o foi poss√≠vel obter a opini√£o do Grok agora."
      };
    }

    // ======== Render Grok ========
    function renderGrok(text){
      const box = document.getElementById('grokOpinion');
      if (!box) return;
      box.innerHTML = text
        ? text.replace(/\n/g, '<br/>')
        : '‚Äî';
    }

    // ======== Prompt p/ Grok com dados do /analyze ========
    function buildGrokMessages(symbol, analyzePayload){
      const isEN = document.documentElement.lang === 'en';
      const d = analyzePayload || {};
      const t = d.technicals || {};
      const a = d.analysts || {};
      const dec = (d.decision || '').toString().toUpperCase();
      const score = typeof d.score === 'number' ? Math.round(d.score) : null;

      const summary = {
        symbol,
        decision_calc: dec,
        score_calc: score,
        technicals: {
          sma50: t.sma50, sma200: t.sma200, rsi14: t.rsi,
          macd: t.macd?.macd, signal: t.macd?.signal, hist: t.macd?.hist
        },
        analysts: {
          mean: a.mean, trend: a.trend
        }
      };

      const qPT = `Baseado APENAS nos indicadores t√©cnicos e nos dados dos analistas fornecidos em JSON a seguir,
responda come√ßando pela CONCLUS√ÉO (uma palavra: "COMPRAR", "VENDER" ou "MANTER"), e logo depois explique o racional em 3‚Äì5 frases objetivas.
Evite jarg√µes e n√£o fa√ßa recomenda√ß√£o personalizada. Mantenha tom educacional e conciso.`;

      const qEN = `Based ONLY on the provided technical indicators and analyst data (JSON below),
start with the CONCLUSION (one word: "BUY", "SELL", or "HOLD"), then explain the rationale in 3‚Äì5 concise sentences.
Avoid personalization and keep an educational tone.`;

      const userContent = (isEN ? qEN : qPT) + `\n\nSYMBOL: ${symbol}\nDATA:\n` + JSON.stringify(summary, null, 2);

      const systemContent = isEN
        ? "You are a financial analysis assistant. Provide concise, educational summaries. Do not give personalized advice."
        : "Voc√™ √© um assistente de an√°lise financeira. Forne√ßa resumos concisos e educacionais. N√£o d√™ aconselhamento personalizado.";

      return [
        { role: "system", content: systemContent },
        { role: "user", content: userContent }
      ];
    }

    // ======== Chamada ao /kimi (Grok via OpenRouter) ========
    async function askGrok(symbol, analyzePayload){
      const lbl = grokDict();
      const titleEl = document.getElementById('grokTitle');
      if (titleEl) titleEl.textContent = lbl.title;

      const box = document.getElementById('grokOpinion');
      if (box) box.textContent = lbl.thinking;

      try{
        const messages = buildGrokMessages(symbol, analyzePayload);
        const resp = await fetch(API_BASE + "/kimi?model=" + encodeURIComponent("x-ai/grok-4-fast"), {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ messages })
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const j = await resp.json();
        const content = j?.choices?.[0]?.message?.content || '';
        renderGrok(content || lbl.error);
      }catch(e){
        console.error('grok error', e);
        renderGrok(grokDict().error);
      }
    }

    // ======== Fluxo principal da Opini√£o AI ========
    async function runAIAnalysis(symbol){
      const d = aiDict();
      const aiStatus = document.getElementById('aiStatus');
      aiStatus.textContent = d.refresh+"‚Ä¶";
      try{
        const resp = await fetch(AI_API + "?symbol=" + encodeURIComponent(symbol), { cache:'no-store' });
        if(!resp.ok) throw new Error('HTTP '+resp.status);
        const json = await resp.json();

        // Render do c√°lculo local (/analyze)
        renderAIResult(json);

        // Chama Grok para opini√£o extra baseada no JSON do /analyze
        askGrok(symbol, json);

        aiStatus.textContent = d.ai_last_update+': '+new Date().toLocaleString(document.documentElement.lang==='en'?'en-US':'pt-BR',{hour12:false});
      }catch(e){
        console.error('AI analyze error', e);
        aiStatus.textContent = (document.documentElement.lang==='en'?'Could not analyze now.':'N√£o foi poss√≠vel analisar agora.');
      }
    }
    document.getElementById('aiAnalyzeBtn').addEventListener('click', ()=>{
      const s = document.getElementById('aiSymbolInput').value.trim() || getCurrentSymbol();
      if(!s) return; runAIAnalysis(s);
    });
    document.getElementById('aiUseChartBtn').addEventListener('click', ()=>{
      const s = getCurrentSymbol();
      document.getElementById('aiSymbolInput').value = s;
    });

    // ===================== Posi√ß√µes: p√∫blico + local =====================
    const posKeyLocal = 'positions_v4_pl_only_autorefresh';
    const cacheKey = 'positions_last_prices_cache_v1';
    const $tbody = document.querySelector('#posTable tbody');
    const $totals = document.getElementById('totals');
    const quoteStatus = document.getElementById('quoteStatus');
    const lastRefreshEl = document.getElementById('lastRefresh');

    let publicPositions = [];
    function readPositionsLocal(){ try{ return JSON.parse(localStorage.getItem(posKeyLocal)) || []; }catch{ return []; } }
    function writePositionsLocal(data){ localStorage.setItem(posKeyLocal, JSON.stringify(data)); }
    function readCache(){ try{ return JSON.parse(localStorage.getItem(cacheKey)) || {}; }catch{ return {}; } }
    function writeCache(obj){ localStorage.setItem(cacheKey, JSON.stringify(obj||{})); }
    function number(v){ return isNaN(parseFloat(v)) ? 0 : parseFloat(v); }
    function fmt(n, d=2){ if(n===null||n===undefined||isNaN(n)) return '-'; return Number(n).toFixed(d); }
    function fmtPct(n){ if(n===null||n===undefined||isNaN(n)) return '-'; return (n>=0?'+':'')+Number(n).toFixed(2)+'%'; }

    function getAllPositions(){
      const locals = readPositionsLocal();
      return [...publicPositions.map(p => ({...p, __public:true})), ...locals.map(p => ({...p, __public:false}))];
    }

    let latestQuotesMap = {};
    function renderPositions(quotesMap={}){
      latestQuotesMap = quotesMap;
      const dict = I18N[currentLang] || I18N.pt;
      const data = getAllPositions();
      $tbody.innerHTML = '';
      data.forEach((row, idx)=>{
        const last = (typeof quotesMap[row.symbol] === 'number') ? quotesMap[row.symbol] : null;
        const pl = (last && row.avg>0) ? ((last/row.avg-1)*100) : null;
        const badge = row.__public ? ' <span class="badge" title="Vis√≠vel para todos">üåê</span>' : '';
        const actions = row.__public
          ? '<span class="muted-small">‚Äî</span>'
          : `<button class="btn small" data-act="edit" data-idx="${idx}">${dict.edit}</button>
             <button class="btn small ghost" data-act="del" data-idx="${idx}">${dict.del}</button>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><button class="btn small" data-act="show" data-idx="${idx}" title="Mostrar no gr√°fico">${row.symbol}</button>${badge}</td>
          <td>${fmt(row.avg)}</td>
          <td>${last===null?'-':fmt(last)}</td>
          <td style="font-weight:700; color:${pl===null?'#334155':(pl>=0?'#15803d':'#b91c1c')}">${pl===null?'-':fmtPct(pl)}</td>
          <td>${row.note||''}</td>
          <td class="actions">${actions}</td>`;
        $tbody.appendChild(tr);
      });
      $totals.textContent = (dict.totals||'').replace('{n}', data.length);
    }

    async function loadPublicPositions(){
      try{
        const r = await fetch(POS_API, { cache:'no-store' });
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json();
        publicPositions = Array.isArray(j.positions) ? j.positions : [];
      }catch(e){
        console.error('loadPublicPositions', e);
        publicPositions = [];
      }
      await refreshPrices();
    }

    function addPositionLocal(){
      const symbol = document.getElementById('posSymbol').value.trim() || getCurrentSymbol();
      const avg = number(document.getElementById('posAvg').value);
      const note = document.getElementById('posNote').value.trim();
      if(!symbol || avg<=0){
        alert(document.documentElement.lang==='en' ? 'Please fill symbol and avg. price.' : 'Preencha s√≠mbolo e pre√ßo m√©dio.');
        return;
      }
      const data = readPositionsLocal();
      data.push({symbol, avg, note});
      writePositionsLocal(data);
      document.getElementById('posSymbol').value='';
      document.getElementById('posAvg').value='';
      document.getElementById('posNote').value='';
      refreshPrices();
    }

    async function publishLocalPositions(){
      const token = localStorage.getItem('admin_token') || prompt('Admin token (Bearer):');
      if(!token){ return; }
      localStorage.setItem('admin_token', token);
      const list = readPositionsLocal();
      try{
        const r = await fetch(POS_API, {
          method:'POST',
          headers:{ 'content-type':'application/json', 'authorization':'Bearer '+token },
          body: JSON.stringify({ positions: list })
        });
        if(!r.ok){
          const t = await r.text().catch(()=> '');
          throw new Error(`HTTP ${r.status} ${t}`);
        }
        alert('Posi√ß√µes publicadas com sucesso!');
        await loadPublicPositions();
      }catch(e){
        console.error('publishLocalPositions', e);
        alert('Falha ao publicar. Verifique o token em ADMIN_TOKEN no Worker.');
      }
    }

    document.getElementById('addPosBtn').addEventListener('click', addPositionLocal);
    document.getElementById('publishBtn').addEventListener('click', publishLocalPositions);
    document.getElementById('loadPublicBtn').addEventListener('click', loadPublicPositions);

    document.getElementById('clearAllBtn').addEventListener('click', ()=>{
      if(confirm(document.documentElement.lang==='en' ? 'Clear all LOCAL positions?' : 'Limpar as posi√ß√µes LOCAIS?')){
        writePositionsLocal([]); renderPositions(latestQuotesMap);
      }
    });
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const rows = readPositionsLocal();
      const header = ['symbol','avg','note'];
      const csv = [header.join(',')].concat(rows.map(r=> `${r.symbol},${r.avg},"${(r.note||'').replace(/"/g,'""')}"`)).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'positions_local.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    document.querySelector('#posTable tbody').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const act = btn.getAttribute('data-act');
      const idx = parseInt(btn.getAttribute('data-idx'),10);
      const data = getAllPositions();
      const row = data[idx];
      if(act==='del'){
        if(row.__public){ alert('Posi√ß√£o p√∫blica n√£o pode ser apagada por aqui. Use o bot√£o "Publicar..." para sobrescrever.'); return; }
        const locals = readPositionsLocal();
        const found = locals.findIndex(x=> x.symbol===row.symbol && x.avg===row.avg && x.note===row.note);
        if(found>-1){ locals.splice(found,1); writePositionsLocal(locals); refreshPrices(); }
      }else if(act==='edit'){
        if(row.__public){ alert('Posi√ß√£o p√∫blica n√£o pode ser editada por aqui. Edite local e publique.'); return; }
        const locals = readPositionsLocal();
        const found = locals.findIndex(x=> x.symbol===row.symbol && x.avg===row.avg && x.note===row.note);
        if(found===-1) return;
        const symbol = prompt(document.documentElement.lang==='en'?'Symbol:':'S√≠mbolo:', row.symbol) || row.symbol;
        const avg = parseFloat(prompt(document.documentElement.lang==='en'?'Avg. price:':'Pre√ßo m√©dio:', row.avg)) || row.avg;
        const note = prompt(document.documentElement.lang==='en'?'Note:':'Observa√ß√£o:', row.note||'') || row.note;
        locals[found] = {symbol, avg, note};
        writePositionsLocal(locals); refreshPrices();
      }else if(act==='show'){
        document.getElementById('chartSymbolInput').value = row.symbol; loadChart(row.symbol);
      }
    });

    // ===================== Pre√ßos via Worker =====================
    async function refreshPrices(){
      const rows = getAllPositions();
      const symbols = [...new Set(rows.map(r => (r.symbol||'').trim()).filter(Boolean))];
      if (symbols.length === 0) {
        renderPositions({}); quoteStatus.textContent = (document.documentElement.lang==='en' ? 'No positions.' : 'Sem posi√ß√µes.');
        lastRefreshEl.textContent = ''; document.getElementById('lastRefreshTop').textContent = '‚Äî'; return;
      }
      quoteStatus.textContent = (document.documentElement.lang==='en' ? 'Updating prices‚Ä¶' : 'Atualizando pre√ßos‚Ä¶');
      try{
        const url = QUOTE_API + "?symbols=" + encodeURIComponent(symbols.join(','));
        const resp = await fetch(url, { cache: 'no-store' });
        if(!resp.ok) throw new Error('HTTP ' + resp.status);
        const json = await resp.json();
        const map = json?.prices || {};
        const out = {};
        rows.forEach(r => { const v = map[r.symbol]; out[r.symbol] = (typeof v === 'number') ? v : null; });
        renderPositions(out);
        quoteStatus.textContent = '';
        const formatted = new Date().toLocaleString(document.documentElement.lang==='en'?'en-US':'pt-BR', {hour12:false});
        lastRefreshEl.textContent = (document.documentElement.lang==='en' ? 'Last update: ' : '√öltima atualiza√ß√£o: ') + formatted;
        document.getElementById('lastRefreshTop').textContent = formatted;
        writeCache(out);
      }catch(e){
        console.error('quotes error', e);
        renderPositions(readCache());
        quoteStatus.textContent = (document.documentElement.lang==='en' ? 'Could not update quotes.' : 'N√£o foi poss√≠vel atualizar as cota√ß√µes.');
      }
    }

    // ===================== Inicializa√ß√£o =====================
    document.getElementById('y').textContent = new Date().getFullYear();
    applyI18n();
    loadChart('NASDAQ:AAPL');
    loadPublicPositions();
    document.getElementById('refreshBtn').addEventListener('click', refreshPrices);
    setInterval(refreshPrices, 120000);
  });
  </script>
</body>
</html>
